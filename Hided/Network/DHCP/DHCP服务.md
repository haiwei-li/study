
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 什么是DHCP](#1-什么是dhcp)
* [2 DHCP的工作原理](#2-dhcp的工作原理)
	* [2.1 名词解释](#21-名词解释)
	* [2.2 工作原理](#22-工作原理)
* [3 配置DHCP服务器端](#3-配置dhcp服务器端)
	* [3.1 设置DHCP服务器静态IP和主机名](#31-设置dhcp服务器静态ip和主机名)
	* [3.2 安装DHCP软件包](#32-安装dhcp软件包)
	* [3.3 配置DHCP主配置文件](#33-配置dhcp主配置文件)
* [4 客户端的配置](#4-客户端的配置)
	* [4.1 客户端的dns是否符合](#41-客户端的dns是否符合)
	* [4.2 观察路由](#42-观察路由)
	* [4.3 查看端口](#43-查看端口)
	* [4.4 查看客户端所记载的租约记录信息](#44-查看客户端所记载的租约记录信息)
* [5 总结](#5-总结)
* [参考](#参考)

<!-- /code_chunk_output -->

# 1 什么是DHCP

Dhcp就是动态主机配置协议, 可以自动的去分配IP地址、子网掩码、网关以及DNS等tcp/ip信息. 当局域网中电脑十分的多的时候, 咱总不能一台一台的去主机旁设IP等信息吧, 那不累死了. 所以只需要在局域网中设置一台DHCP服务器, 通过此服务器就可以动态的给局域网中的每台电脑自动设置IP等信息. 

# 2 DHCP的工作原理

## 2.1 名词解释

首先我们先介绍几个名字解释: 

DHCP客户端: DHCP客户是通过DHCP来获得网络配置参数的internet主机, 通常就是普通的用户工作站. 

DHCP服务器: DHCP服务器是提供网络参数的给DHCP客户的internet主机

DHCP/BOOTP中继代理: 在DHCP客户和服务器之间转发DHCP消息的主机或者路由器

DHCP是基于客户机/服务器模型设计的, DHCP客户和DHCP服务器之间通过收发DHCP消息进行通讯. 

作用域: 一个完整连续的可用IP地址薄, DHCP服务主要就是通过作用域来管理网络分布、IP地址分配及相关配置参数. 

排除范围: 排除范围是作用域内从DHCP服务中排除的有限地址序列, 排除范围确保在这些范围中的任何地址都不是由网络上的服务器提供给客户端的. 其实说白了就是将作用域中的一些IP地址给排除在外使其不能分配给客户端. 

地址池: 在定义DHCP作用域并应用排除范围后, 剩余的地址在作用域内形成的可用地址池, 地址池中的地址可以动态分配给DHCP客户端. 

租约: 客户端可以使用动态分配IP地址的时间. 

预约: 创建从**DHCP服务器**到**客户机**的**永久地址租约指定**, 预约可以保证**子网上的特定硬件设备**总是使用**相同的IP**. 

## 2.2 工作原理

首先**DHCP**一般是**局域网**内的一个**通讯协议**, 当客户端没有设定任何网络配置信息时候, 他会想其所在的局域网上发出一个广播封包给局域网内的所有主机(其发送的是DHCP DISCVER数据包, 为保证服务器能够接收到请求, 数据包源地址设定为0.0.0.0, 而目的地址为255.255.255.255, 以广播形式发送DHCP DISCOVER的信息. ), 一般主机接收到这个封包后, 会直接给予丢弃, 但如果局域网中有DHCP服务器, 则会自动响应. 

当DHCP服务器监听到客户端发出的DHCP DISCOVER广播后, 它会从那些还没有租出的地址范围内选择可用的IP及其他TCP/IP设定以DHCP OFFER数据包的形式发送给客户机. 

如果客户端收到网络上多台DHCP服务器的响应, 客户端会挑选最快的一个DHCP OFFER并向网络发送一个DHCP REQUEST广播封包, 告诉所有DHCP服务器它将使用哪一台服务器提供的IP地址. 同时, 客户端还会向网络发送ARP广播数据包, 查询网络上面有没有其他机器使用该IP地址, 如果发现该IP地址已经被占用, 客户端则会发送一个DHCP DECLINE数据包给DHCP服务器, 拒绝接受其DHCP OFFER, 并重新发送DHCP REQUEST信息. 

注:实际上并不是所有DHCP客户端都会无条件接受DHCP服务器的响应, 客户端可以保留自己的一些TCP/IP设定, 比如网关、DNS地址等等

将地址分配给客户端后, DHCP服务器会发送一个DHCP ACK消息, 以确认IP租约的正式生效, 结束完整的DHCP工作过程. 

DHCP客户端成功地从服务器取得IP地址之后, 一般不需要再发送DHCP DISCOVER信息了, 除非其租约已经到期或者IP地址重新设定回0.0.0.0. 此时客户端会直接使用已经租用到的IP地址向为其发此IP地址的DHCP服务器发出DHCP REQUEST信息, DHCP服务器会尽量让客户端使用原来的IP地址, 如果没有特殊的情况, 会直接响应DHCP ACK, 允许客户端继续使用该IP地址. 如果该地址已经失效或者已经被其他主机使用了, 服务器则会响应一个DHCP NACK数据包给客户端, 要求其重新执行DHCP DISCOVER. 

注意: 客户端执行DHCP DISCOVER后, 如果没有DHCP服务器响应客户端的请求, 客户端会随机使用169.254.0.0/16网段中的一个IP地址配置本机地址. 

Ok 大致的过程就是如上所示, 上面也是我摘抄的, 似乎说的比较详细, 简单的说就是在一个存在DHCP服务器的网络环境中, 客户端发送一个目标地址为255.255.255.255的广播给网络中的所有主机, 其他客户端收到此消息会直接丢弃, 而DHCP服务器收到此消息后则会从其地址池中随机选择一个IP给发送此消息的客户端来配置其网络参数, 客户端接收到消息后, 就开始处理本身的网络参数, 包括网关、DNS等等信息, 并且会给服务器发送一个确认信息, 表示该参数已经被接受了, 可别又分给其他客户端. 

这里有个地方需要注意一下,当客户端无论是**关闭网络接口(ifdown**)、**重新启动(reboot**)、**关机(shutdown**)等行为都算是**脱机**, 这个时候服务器端会收回IP, 并放到自己的备用区中, 等待未来使用. 但通过前面我们讲述原理知道"DHCP服务器会尽量让客户端使用原来的IP地址, 如果没有特殊的情况, 会直接响应DHCP ACK, 允许客户端继续使用该IP地址"所以当重启网络服务的时候, 常常会发现IP地址居然没有改变, 原因就在这里. 

# 3 配置DHCP服务器端

首先当然是要安装DHCP, 如果你有yum源的话, 直接

yum install dhcp就可以实现安装, 我先查看下我的主机装了没: 

```
# 查看是否安装dhcp
# rpm -qa dhcp  
```

配置DHCP服务器大概有以下几个步骤: 

## 3.1 设置DHCP服务器静态IP和主机名

```
# 设置网络
[root@sw ~]# vim /etc/sysconfig/network-scripts/ifcfg-eth0  
DEVICE=eth0
HWADDR=08:00:27:47:92:32
TYPE=Ethernet
UUID=f5bdb328-4418-48bc-a461-6ef894ef5269
ONBOOT=yes
NM_CONTROLLED=yes
# 设置为静态ip
BOOTPROTO=none
# 手动添加ip地址
IPADDR=192.168.1.254
# 手动添加子网掩码
NETMASK=255.255.255.0

# 设置主机名和网关
[root@sw ~]# vim /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=server.tarena.com
GATEWAY=192.168.1.254

# 编辑ip和主机名对应解析
[root@sw ~]# vim /etc/hosts
127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4
::1        localhost localhost.localdomain localhost6 localhost6.localdomain6
# 添加解析
192.168.2.254  server.tarena.com

# 编辑默认搜索域名
[root@sw ~]# vim /etc/resolv.conf 
# Generated by NetworkManager
search tarena.com

# 重启服务器使配置生效
[root@sw ~]# shutdown -r 0 
```

## 3.2 安装DHCP软件包

```
# 安装软件包(红帽企业版会有所不同)
[root@server Packages]# rpm -ivh dhcp-4.1.1-38.P1.el6.centos.i686.rpm

# 确认安装
[root@server ~]# rpm -q dhcp确认安装
dhcp-4.1.1-38.P1.el6.centos.i686
```

## 3.3 配置DHCP主配置文件

```
# 先备份配置文件
[root@server ~]# cp /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.conf.bak   

# 编辑主文件(可从模板文件导入)
[root@server ~]# vim /etc/dhcp/dhcpd.conf 
#设置局部待分配网段
subnet 192.168.1.0 netmask 255.255.255.0  { 
#设地址池
range 192.168.1.20 192.168.1.200;
#设要分配的DNS服务器地址
option domain-name-servers 192.168.1.253,114.114.114.114; 
# 设局域网域名
option domain-name "tarena.com";
# 设置要分配的网关地址
option routers 192.168.1.254; 
# 设置广播地址
option broadcast-address 192.168.1.255; 
#默认地址租约时间(秒)
default-lease-time 600;
#最长地址租约时间(秒)
max-lease-time 7200;
}
#win7只是个名称而已设保留地址(固定分配ip)
host win7 {
#设要绑定的mac
hardware ethernet 08:00:07:26:c0:a5;
#设绑定ip地址
fixed-address 192.168.1.7;
}

# 启动服务
[root@server ~]# service dhcpd restart     

# 设为开机启动
[root@server ~]# chkconfig dhcpd on          
# 查看开机
[root@server ~]# chkconfig --list
```

........

# 4 客户端的配置

其实客户端也没啥配置的, 只要设置成dhcp方式来获取ip就可以了. 设置好后, 我们重启网络就可以从刚刚配置好的dhcp服务器上来获取ip了, 就这么简单. 

现在我们在客户端上来观察下其相关参数都是否符合配置: 

## 4.1 客户端的dns是否符合

```
[root@server ~]# cat /etc/resolv.conf
; generated by /sbin/dhclient-script
search johntest
nameserver 192.168.1.8
```

客户端的dns已经是是我们设定的dns地址了, 注意观察哦, 这里的

search johntest 就是我们在服务器上设置的"option domain\-name"的名称, 

nameserver 即是我们服务器上设置的地址. 所以完全吻合

```
[root@johntest ~]# ifconfig
eth0 Link encap:Ethernet HWaddr 00:0C:29:5D:41:62
inet addr:192.168.0.101 Bcast:192.168.0.255 Mask:255.255.255.0
```

我们服务器上是设置了给客户端绑定ip为192.168.1.20, 也符合

## 4.2 观察路由

```
[root@johntest ~]# route -n   #查看路由表
Kernel IP routing table
Destination Gateway Genmask Flags Metric Ref Use Iface
192.168.0.0 0.0.0.0 255.255.255.0 U 0 0 0 eth0
169.254.0.0 0.0.0.0 255.255.0.0 U 0 0 0 eth0
0.0.0.0 192.168.1.8 0.0.0.0 UG 0 0 0 eth0
```

观察发现和我服务器上设置的192.168.1.8是一致的

## 4.3 查看端口

Dhcp客户端所用的端口是68, 现在我们来检查下: 

```
# netstat -tulnp #查看端口号
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1009/sshd
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1227/master
tcp6       0      0 :::111                  :::*                    LISTEN      1/systemd
tcp6       0      0 :::22                   :::*                    LISTEN      1009/sshd
tcp6       0      0 ::1:25                  :::*                    LISTEN      1227/master
udp        0      0 0.0.0.0:7132            0.0.0.0:*                           808/dhclient
udp        0      0 0.0.0.0:68              0.0.0.0:*                           808/dhclient
udp6       0      0 :::32594                :::*                                808/dhclient
```

## 4.4 查看客户端所记载的租约记录信息

```
[root@linux101 dhclient]# cat /var/lib/dhclient/dhclient-eth0.leases

lease {

lease {

interface "eth0"; //所监听的端口

fixed-address 192.168.0.101; //ip地址

option subnet-mask 255.255.255.0; //所取得的子网掩码

option time-offset -18000;

option routers 192.168.0.1; //路由地址

option dhcp-lease-time 21600; //租约时间

option dhcp-message-type 5;

option domain-name-servers 192.168.0.102; //dns的地址

option dhcp-server-identifier 192.168.0.102;

option nis-domain "domain.org";

option domain-name "linux102"; //dns主机名称

renew 2 2011/8/9 11:22:19; //下一次预计更新(renew)时间

rebind 2 2011/8/9 13:47:58;

expire 2 2011/8/9 14:32:58;

}
```

这个档案会记录该适配卡所有曾经要求过的DHCP 信息！几乎就与你设定的/etc/dhcpd.conf 类似

# 5 总结

基本的DHCP服务器搭建流程:

(1)编辑主配置文件dhcpd.conf, 指定IP作用域(指定一个或多个IP地址范围). 

(2)建立租约数据库文件. 

(3)重新加载配置文件或重新启动dhcpd服务使配置生效. 

DHCP工作流程: 

(1)客户端发送广播向服务器申请IP地址. 

(2)服务器收到请求后查看主配置文件dhcpd.conf, 先根据客户端的MAC地址查看是否为客户端设置了固定IP地址. 

(3)如果为客户端设置了固定IP地址则将该IP地址发送给客户端. 如果没有设置固定IP地址, 则将地址池中的IP地址发送给客户端. 

(4)客户端收到服务器回应后, 客户端给于服务器回应, 告诉服务器已经使用了分配的IP地址. 

(5)服务器将相关租约信息存入数据库. 

在服务器端:  service dhcpd restart

可以用tcpdump抓包工具 监听下eth0 端口(我设置的是et0端口)

在client端:   dhclient eth0

然后等待, 看服务器端的监听窗口, 会发现有信息进入, 抓包信息. 

在客户端等待, 运行ifconfig 后, 会发现eth0的地址会改变. 

注: 不要直接使用dhclient, 而是network manager管理.

# 参考

https://blog.51cto.com/woyaoxuelinux/1890611

- DHCP服务器之DHCP配置: http://network.51cto.com/art/201009/223883.htm