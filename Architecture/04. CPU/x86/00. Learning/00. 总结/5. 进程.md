
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1 上下文](#1-上下文)
- [2 上下文切换](#2-上下文切换)

<!-- /code_chunk_output -->

进程是各种资源的合集, 通常一个进程包含以下几种资源.

(1) **私有**的**线性地址空间**: 这是**进程可以使用的线性地址的总和**, 其中**内核部分**可能和其它进程是**共享**的.

(2) **可执行的程序**: 也就是**二进制序列**, 包含**代码和数据**.

(3) 一些已经获得的**其它资源**, 如**打开的文件**、**管道**等.

(4) **进程的权限**: 进程的**运行权限**, 例如 Linux 中有 root 用户和非 root 用户之分

(5) 进程的描述符: 有的操作系统成为控制块, 包含操作该进程的一些必要信息, 例如进程 ID 号

这里介绍和虚拟化技术最紧密的概念--上下文.

# 1 上下文

上下文就是程序(进程/中断)运行时所需要的寄存器的最小集合. 这些寄存器的后面一般代表着程序运行的一类资源例如 LDTR 就代表着某个进程所使用的段信息 CR3 寄存器就代表着进程的私有线性地址空间(分页机制启动时).

下面看下 x86 下上下文包含的寄存器.

(1) 通用寄存器组: EAX、EBX、ECX、EDX、ESI、EDI 这 6 个 加上 ESP(栈指针)、EBP(框架指针).

(2) 段相关寄存器组: CS、DS、SS, 如果程序使用了 ES 等额外段寄存器, 也要包含进来.

(3) 标志寄存器: 主要指 EFLAGS 寄存器.

(4) 程序指针寄存器: EIP

(5) GDT 基地址: 用于访问 GDT、GDTR 中的内容

(6) LDT 段选择符: 如果程序使用了私有的 LDT, LDTR 的内容

(7) IDT 基地址: 用于访问 IDT 表, IDTR 的内容

(8) 控制寄存器组: CR 系列, 表示当前程序运行时的 CPU 控制状态

(9) 浮点相关寄存器组: 用于浮点计算的一些寄存器组

(10) 一些特殊用途的寄存器: 例如 x86 架构下的 MSR(Model\-Specific Registers)

一个程序的上下文可能是上面列出内容的一个子集(例如进程), 也可能是全部(例如虚拟机). 从程序员的观点看, 通常对于上下文切换时不需要改变的寄存器, 也可以说它不是改程序的上下文. 例如进程切换时, GDTR 中的内容不需要改变, 为了方便, 通常在一个进程的上下文时不把 GDTR 算进去. 后面内容, 提到的上下文都是指在上下文切换时必须更改的寄存器的集合.

# 2 上下文切换

在操作系统中, 通常只有**三种情况**会发生上下文切换.

(1) 用户态到内核态的切换: 因为运行在不同的 Ring 级别, 对资源的访问权限不同, 需要切换部分上下文. 例如, 从用户态的栈切换到内核态的栈

(2) 进程切换: 一个 CPU 在一个时刻只能处理一个进程进程切换的实质就是将**被终止运行的进程的上下文相关寄存器**的值换成**新进程的相关值**同时将**被终止运行的进程**的上下文**相关寄存器的值**存储在该进程的**私有堆栈**中. 这通常是全上下文的切换. 例如把 CR3 换成新进程页目录的地址 EIP 指向新进程运行的第一条指令等.

(3) 到中断上下文的切换: 中断的处理函数运行在特殊的上下文环境, 称为中断上下文. CPU 处理一个中断时, 不管当前 CPU 在运行一个进程, 还是本身就是在一个中断上下文, 都要切换到中断上下文. 例如, 更改栈指针、EIP 变化等. 这通常是部分上下文的切换, 例如 CR3 寄存器的值就不需要更改. 根据 x86 架构特点, 处理中断必然经过一个中断上下文阶段, 可能的情况是:

⓵ 进程上下文 -> 中断上下文(处理中断) -> 进程上下文(中断返回执行)

⓶ 进程上下文 -> 中断上下文 -> 新进程上下文(处理中断) -> 进程上下文(最先被打断进程的上下文)

⓷ 中断上下文 -> 新中断上下文 -> ......

x86 只有一种机制, 即任务门(Task Gate)可以使中断的处理不经过中断上下文而直接进入进程上下文, 但几乎没有操作系统使用它, 而且 x86\_64 已经取消了任务门.

上下文切换通常有两步:

⓵ 保存旧上下文: 相关寄存器的值保存在内存中

⓶ 加载新的上下文: 新的寄存器信息从内存中读入, 加载到对应寄存器中

**保存旧的上下文动作**在 x86 架构下有时会由 CPU 自动完成一部分(例如中断发生, 使用 TSS), 但在**现代操作系统**中, 通常由**软件完成(！！！**).

