
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 异常源](#1-异常源)
  - [1.1. 异常的不可屏蔽和 NMI](#11-异常的不可屏蔽和-nmi)
- [2. 运行错误产生的异常](#2-运行错误产生的异常)
- [3. 由软件主动发起异常](#3-由软件主动发起异常)
- [4. Machine Check(机器检查)异常](#4-machine-check机器检查异常)
- [5. 总结](#5-总结)

<!-- /code_chunk_output -->

# 1. 异常源

可产生异常的异常源来自:

1) **运行的代码产生了错误**, 从而引发异常产生

2) 由**软件主动引发的异常**

3) **Machine\-Check(机器检查)引发的异常**

异常是**不能被屏蔽的**, 无论是执行错误还是主动引发异常, 实质上是在**处理器内部引发**.

## 1.1. 异常的不可屏蔽和 NMI

这个不可屏蔽与 NMI 是不同的

1) NMI 由硬件引起, 包括: **外部 NMI 源**, 以及 **local APIC** 与 **I/O APIC** 交付的 NMI

2) 对于**外部 NMI 源**可以通过 **de-assert PIN 方式**或**屏蔽 LINT1 的方式**来屏蔽中断.

# 2. 运行错误产生的异常

由**运行代码错误产生的异常**是很常见的, 在**保护模式**下我们或许会常与 `#GP`(**General Protected**)异常或与 `#PF`(**Page Fault**)异常打交道

下面情况下代码会产生运行错误.

1. 代码产生了**逻辑错误**: 典型地, 除 0 错误产生`#DE`(Divide Error)异常

2. 处理器遇到**无法执行**的错误: 例如 `#UD`(Invalid Opcode)异常, 处理器遇到了**不支持的指令**, 它不可能得到执行

3. 代码违反了处理器的某些**保护措施**: 典型地, 如 `#GP` 异常, `#PF`异常, `#SS` 异常等. 这些措施是处理器为了某些管理机制而设置, 违反这些措施处理器将产生异常来提醒软件.

后面将看到这些异常有些可以恢复,有些不行.

# 3. 由软件主动发起异常

软件可以使用下面指令发起异常

1. **INT3 指令**: 处理器遇到**INT3 指令**(opcode 码为 0xCC)产生`#BP`(Breakpoint)断点异常对应的向量号为 3, 属于**trap 类型**.

2. **INTO 指令**: 软件执行**INTO 指令**, 处理器检测到 eflags 寄存器的 OF 标志位置位时, 将产生`#OF`(Overflow)**溢出异常！！！** 对应的向量号为 4, 属于 trap 类型, **64 位模式下该指令无效**.

3. **BOUND 指令**: 软件执行 BOUND 指令, 处理器检测到**操作数越界**时将产生`#BR`(Bound Range)异常. **64 位模式下指令无效**.

4. **INT1 指令**: opcde 码 F1

INT n 指令可用于在软件中模拟异常;  但有一个限制. 如果 n 为体系结构定义异常的向量, 则处理器生成正确向量的中断(以访问异常处理程序), 但不会将错误代码推送到堆栈上.  即使关联的硬件生成的异常通常会产生错误代码, 也是如此.  异常处理程序在处理异常时仍会尝试从堆栈中弹出错误代码.  因为没有推送错误代码, 处理程序将弹出并丢弃 EIP(代替丢失的错误代码).  这会将退回发送到错误的位置.

# 4. Machine Check(机器检查)异常

处理器提供了对**处理器内部或外部进行检查**的机制, 当检测到错误的发生时, 处理器将产生`#MC`(Machine Check)异常

# 5. 总结

异常包括硬件异常和软件异常.

* 一般, **硬件异常**是指**除了**`#BP`(**INT3 指令**)与 `#OF` 异常(**INTO 指令**)以外的**所有异常**

> 它们属于**fault 或 abort 类型异常**. 也包括由**BOUND 指令**产生的`#BR`异常及由**UD 指令**产生的`#UD`异常. 所有类型的`#DB 异常`(也包括了 trap 类型)也属于硬件异常. **硬件异常的向量号必须是 0\~31(！！！**).

> 能**产生错误码**的**硬件异常**是: `#DF`, `#TS`, `#NP`, `#SS`, `#GP`, `#PF`及`#AC`这 7 类.

* **软件异常**指由 `INT3` 与 `INTO 指令` 产生的 `#BP` 与 `#OF` 异常.


INT1 指令呢???