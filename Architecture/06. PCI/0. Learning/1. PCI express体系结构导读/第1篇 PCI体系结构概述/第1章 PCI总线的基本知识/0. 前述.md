<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. PCI 总线](#1-pci-总线)
- [2. PCI 优点](#2-pci-优点)
  - [2.1. PCI 总线空间与处理器空间隔离](#21-pci-总线空间与处理器空间隔离)
  - [2.2. 可扩展性](#22-可扩展性)
  - [2.3. 动态配置机制](#23-动态配置机制)
  - [2.4. 总线带宽](#24-总线带宽)
  - [2.5. 共享总线机制](#25-共享总线机制)
  - [2.6. 中断机制](#26-中断机制)
- [3. 小结](#3-小结)

<!-- /code_chunk_output -->

# 1. PCI 总线

PCI 总线作为处理器系统的局部总线, 主要目的是**为了连接外部设备**, 而**不是作为处理器的系统总线连接 Cache 和主存储器**. 但是 **PCI 总线**、**系统总线**和**处理器体系结构**之间依然存在着紧密的联系.

PCI 总线作为系统总线的延伸, 其设计考虑了许多与处理器相关的内容, 如处理器的 Cache 共享一致性和数据完整性, 以及如何与处理器进行数据交换等一系列内容. 其中 Cache 共享一致性和数据完整性是现代处理器局部总线的设计的重点和难点, 也是本书将重点讲述的主题之一.

独立地研究 PCI 总线并不可取, 因为 **PCI 总线**仅是**处理器系统的一个组成部分**. 深入理解 PCI 总线需要了解一些与处理器体系结构相关的知识. 这些知识是本书所侧重描述的同时也是 PCI 总线规范所忽略的内容. 脱离实际的处理器系统不容易也不可能深入理解 PCI 总线规范.

# 2. PCI 优点

对于今天的读者来说 PCI 总线提出的许多概念略显过时也有许多不足之处. 但是在当年 PCI 总线与之前的存在其他并行局部总线如 ISA、EISA 和 MCA 总线相比具有许多突出的优点是一个全新的设计.

## 2.1. PCI 总线空间与处理器空间隔离

(1) PCI 总线空间与处理器空间隔离

PCI 设备具有**独立的地址空间**, 即 **PCI 总线地址空间**. 该空间与存储器地址空间通过 **HOST 主桥隔离**. **处理器**需要通过 **HOST 主桥**才能访问 PCI 设备, 而 **PCI 设备需要通过 HOST 主桥才能访问主存储器**. 在 **HOST 主桥**中含有**许多缓冲**, 这些缓冲使得处理器总线与 PCI 总线工作在各自的时钟频率中, 彼此互不干扰. HOST 主桥的存在也使得 PCI 设备和处理器可以方便地共享主存储器资源.

**处理器访问 PCI 设备**时, 必须**通过 HOST 主桥进行地址转换**; 而**PCI 设备访问主存储器**时, 也需要**通过 HOST 主桥进行地址转换**. HOST 主桥的一个重要作用就是**将处理器访问的存储器地址转换为 PCI 总线地址**. PCI 设备使用的地址空间是属于 PCI 总线域的, 这与存储器地址空间不同.

**x86** 处理器对 **PCI 总线域**与**存储器域**的**划分并不明晰**, 这也使得许多程序员并没有准确地区分 PCI 总线域地址空间与存储器域地址空间. 而本书将反复强调存储器地址和 PCI 总线地址的区别, 因为这是理解 PCI 体系结构的重要内容.

**PCI 规范**并**没有**对 **HOST 主桥**的设计进行约束. **每一个处理器厂商**使用的 HOST 主桥其设计都不尽相同. HOST 主桥是联系 PCI 总线与处理器的核心部件, **掌握 HOST 主桥的实现机制**是深入理解 PCI 体系结构的前提.

本书将以 Freescale 的 PowerPC 处理器和 Intel 的 x86 处理器为例, 说明各自 HOST 主桥的实现方式, 值得注意的是本书涉及的 PowerPC 处理器仅针对 Freescale 的 PowerPC 处理器, 而不包含 IBM 和 AMCC 的 Power 和 PowerPC 处理器. 而且如果没有特别说明本书中涉及的 x86 处理器特指 Intel 的处理器, 而不是其他厂商的 x86 处理器.

## 2.2. 可扩展性

(2) 可扩展性

PCI 总线具有很强的扩展性. 在 PCI 总线中 **HOST 主桥可以直接推出一条 PCI 总线**, 这条总线也是**该 HOST 主桥**的所**管理的第一条 PCI 总线**, 该总线还可以通过 PCI 桥扩展出一系列 PCI 总线, 并**以 HOST 主桥为根节点**形成 **1 颗 PCI 总线树**. 这些 PCI 总线都可以连接 PCI 设备, 但是**在 1 颗 PCI 总线树**上, 最多只能挂接 **256 个 PCI 设备(包括 PCI 桥)**.

> 一个 host 主桥, 一个 PCI 总线树, 一个 PCI 总线域(多个 PCI 总线), 256 个 PCI 设备

在**同一条 PCI 总线**上的设备间可以直接通信**, 并不会影响其他 PCI 总线上设备间的数据通信. 隶属于**同一颗 PCI 总线树**上的 PCI 设备, 也可以直接通信, 但是需要**通过 PCI 桥**进行**数据转发**.

PCI 桥是 PCI 总线的一个重要组成部件, 该部件的存在使得 PCI 总线极具扩展性. PCI 桥也是有别于其他局部总线的一个重要部件. 在 "以 HOST 主桥为根节点" 的 PCI 总线树中, **每一个 PCI 桥**下也可以连接**一个 PCI 总线子树**, PCI 桥下的 PCI 总线仍然可以使用 PCI 桥继续进行总线扩展.

PCI 桥可以管理这个 PCI 总线子树, **PCI 桥的配置空间**含有一系列管理 PCI 总线子树的配置寄存器. 在 PCI 桥的两端, 分别连接了两条总线分别是上游总线(Primary Bus)和下游总线(Secondary Bus). 其中与处理器距离较近的总线被称为上游总线, 另一条被称为下游总线. 这两条总线间的通信需要通过 PCI 桥进行. PCI 桥中的许多概念被 PCIe 总线采纳, 理解 PCI 桥也是理解 PCIe 体系结构的基础.

## 2.3. 动态配置机制

(3) 动态配置机制

PCI设备使用的地址可以根据需要由系统软件动态分配. PCI总线使用这种方式合理地解决了设备间的地址冲突, 从而实现了"即插即用"功能. 因此PCI总线不需要使用ISA或者 EISA 接口卡为解决地址冲突而使用的硬件跳线.

每一个PCI设备都有独立的配置空间, 在配置空间中含有该设备在PCI总线中使用的基地址, 系统软件可以动态配置这个基地址, 从而保证每一个PCI设备使用的物理地址并不相同. PCI桥的配置空间中含有其下PCI子树所能使用的地址范围.

## 2.4. 总线带宽

(4) 总线带宽

PCI总线与之前的局部总线相比, 极大提高了数据传送带宽32位/33 MH的 PCI总线可以提供 132 MB/s 的峰值带宽, 而6 位/66 MHz 的 PCI 总线可以提供的峰值带宽为532 MB/s. 虽然 PCI 总线所能提供的峰值带宽远不能和 PCIe 总线相比, 是与之前的局部总线SAEISA和 MCA总线相比, 仍然具有极大的优势.

ISA 总线的最高主频为8 MH2, 位宽为 16, 其峰值带宽为16 MB/s;EISA 总线的最高主频为8.33 MHz位宽为32, 其峰值带宽为33 MB/s;而MCA 总线的最高主频为 10 MHZ, 最高位宽为 32, 其峰值带宽为 40 MB/s. PCI总线提供的峰值带宽远高于这些总线.

## 2.5. 共享总线机制

(5) 共享总线机制

PCI 设备通过仲裁获得 PCI 总线的使用权后, 才能进行数据传送, 在 PCI 总线上进行数据传送, 并不需要处理器进行干预.

PCI 总线仲裁器不在 PCI 总线规范定义的范围内, 也不一定是HOST 桥 PCI桥的部分. 虽然绝大多数 **HOST 主桥**和 **PCI 桥**都包含 **PCI 总线仲裁器**, 但是在某些处理器系统的设计中也可以使用独立的 PCI总线仲裁器. 如在 PowerPC处理器的 HOST 桥中含有 PCI总线仲裁器, 但是用户可以关闭这个总线仲裁器, 而使用独立的 PCI总线仲裁器.

PCI 设备使用共享总线方式进行数据传递, 在同一条总线上, 所有 PCI设备共享同一总线带宽, 这将极大地影响 PCI 总线的利用率. 这种机制显然**不如 PCIe 总线**采用的**交换结构**, 但是在 PCI 总线盛行的年代, 半导体的工艺、设计能力和制作成本决定了采用共享总线方式是当时的最优选择.

## 2.6. 中断机制

(6) 中断机制

PCI 总线上的设备可以通过**四根中断请求信号** `INTA~D#` 向处理器提交中断请求. 与 ISA 总线上的设备不同, PCI 总线上的设备可以共享这些中断请求信号, 不同的 PCI 设备可以将这些中断请求信号"线与"后, 与中断控制器的中断请求引脚连接. PCI 设备的配置空间记录了该设备使用这四根中断请求信号的信息.

PCI 总线进一步提出了 **MSI**(Message Signal Interrupt)机制, 该机制使用**存储器写总线事务**传递中断请求, 并可以使用 x86 处理器 FSB(Front Side Bus)总线提供的 Interrupt Message 总线事务, 从而提高了 PCI 设备的中断请求效率.

# 3. 小结

虽然从现代总线技术的角度来看, PCI 总线仍有许多不足之处, 但也不能否认 PCI 总线已经获得了巨大的成功. 不仅 x86 处理器将 PCI总线作为标准的局部总线连接各类外部设备, PowerPC、MIPS 和ARM处理器也将 PCI总线作为标准局部总线. 除此之外, 基于 PCI总线的外部设备, 如以太网控制器、声卡、硬盘控制器等, 也已经成为主流.

> 在 ARM 处理器中, 使用 SoC 平台总线, 即 AMBA 总线, 连接片内设备. 但是某些 ARM 生产厂商, 依然使用 AMBA-to-PCI 桥推出PCI总线, 以连接PCI设备.