许多计算机化的活动都是由定时测量(timing measurement)来驱动的, 比如计算机休眠归因于定时器. 定时机制连同一些更可见的内核活动(如检查超时)来驱使进程切换.

内核必须完成两种重要的定时测量:

- 保存当前的时间和日期, 以便通过系统调用返回给用户程序, 也可由内核本身把当前时间作为文件和网络包的时间戳;

- 维持定时器, 这能告诉内核或用户程序某一段时间间隔已经过去.

定时测量由基于**固定频率振荡器**和**计数器**的几个硬件电路完成.

在 80X86 体系结构中, 内核必须显式地与几种时钟(clock)和定时器(timer)电路打交道. 时钟电路用于跟踪当前时间和产生精确的时间度量. 定时器电路由内核进行编程, 所以以固定的、预先定义的频率发出中断. 该周期性中断对实现内核和用户程序使用的软定时器很重要.

下面描述 IBM 兼容 PC 上的时钟和硬件电路.

## 实时时钟(RTC)

所有的 PC 都包含 RTC(Real Time Clock, 实时时钟), 它独立于 CPU 和所有其他芯片.

电脑关机, RTC 也正常工作, 它靠一个小电池或蓄电池供电. CMOS RAM 和 RTC 集成在一个芯片.

RTC 在 IRQ8 上产生周期性中断, 频率 2 ~ 8192HZ; 也可对其编程, 当 RTC 到达某个特定值激活 IRQ8.

Linux 只用 RTC 来获取时间和日期, 也允许通过对/dev/rtc 对 RTC 进行编程. Kernel 通过 0x70 和 0x71 I/O 端口访问 RTC, 从而可以设置闹钟.

## 时间戳计数器(TSC)

80x86 上的微处理器都有 CLK 输入针脚, 从奔腾系列开始, 微处理器支持一个计数器, 每当一个时钟信号来的时候, 计数器加 1, 可以通过汇编指令 rdtsc 来得到计数器的值.

Linux 在初始化时候必须确定时钟信号的频率, 但是内核不会声明这个频率, 所以同一个内核映像可运行在产生任何时钟频率的 CPU 上.

通过 calibrate_tsc 可以获得 CPU 的频率, 它是通过计算大约 5 毫秒里 tsc 寄存器里面的增加值来确认的. 或者可以通过 cat /proc/cpuinfo 来获取 cpu 频率. tsc 可以提供比 PIT 更精确的时间度量.

## 可编程间隔定时器(PIT)

除了 RTC 和 TSC, IBM 兼容 PC 还包含了可编程间隔定时器(Programmable internval timer, PIT). PIT 类似微波炉的闹钟机制, 当时间到的时候, 提供铃声, PIT 不是产生铃声, 而是产生一种特殊中断, 叫定时器中断或者时钟中断. 它用来告诉内核一个间隔过去了. 这个时间间隔也叫做一个滴答数. PIT 永远以**内核确定的固定频率**不停发出中断.

如内核频率设为 1000HZ,则时间间隔或滴答为 1/1000=1 微秒. 滴答越短, 定时精度更高, 但是用户模式的时间更短, 也就是说用户模式下程序执行会越慢. 滴答的长度以纳秒形式存在 tick_nsec 变量里面. 每个 IBM 兼容 PC 至少包含一个 PIT, PIT 通常通过 8254 CMOS 芯片的 0x40--0x43 端口来访问. 它产生中断号为 IRQ 0.

下面是关于 pIT 里面的一些宏定义:

HZ: 每秒中断数.

CLOCK_TICK_RATE:值是 1,193,182, 它是 8254 芯片内部振荡器频率.

LATCH: 代表 CLOCK_TICK_RATE 和 HZ 的比率, 被用来编程 PIT.

## CPU 本地定时器

最近的 80x86 架构的微处理器上的 local apic 提供了 cpu local timer.他和 pit 区别在于它提供了 one-shot 和 periodic 中断. 它可以使中断发送到特定 cpu. one-shot 中断常用在实时系统里面.

## 高精度事件定时器(HPET)

HPET(High Precision Event Timer) 称高精度定时器(到时了产生中断)是 Intel 和 MS 开发的一种新型定时器芯片, 最低时钟频率为 10MHZ, 而且定义了比较严格的精确度.

HPET 是指一组可被内核使用的定时器, 最多可扩展为 8 个 block, 而每个 block 最多可有 32 个可编程的 timer,也就是最多可以实现 256 个 timer 共同工作.

**每一个 block** 都会有一个**主定时计数器**(该计数器可以由自己的时钟信号驱动), 以及最多 32 个逻辑比较器, 及最多 32 个匹配寄存器. 主定时计数器会时时刻刻产生嘀嗒, 而一个比较器与一个比较寄存器组和起来就形成了一个 timer(当然还有一些配置寄存器).

可以编程添入一个期望的值到比较寄存器中, 当经过一定的时间, 比较器判断主计数器与比较寄存器的值相同便产生了一个中断(中断发往哪里也是可以编程的). 当然每个 timer 都可配置为周期时钟或是非周期时钟的. 而且 HPET 可以通过配置来代替古老的 PIT(8254)及 RTC 时钟的.

HPET 精确度高而且灵活.

## ACPI 电源管理定时器

ACPI PMT 是另一种时钟设备, 包含在几乎所有基于 ACPI 的主板上, 时钟信号拥有大约 3.58MHz 的固定频率. 该设备实际上是个计数器, 每个时钟节拍到来增加一次. 为读取计数器当前值, 内核需要访问某个 I/O 端口, 该端口地址由 BIOS 在初始化阶段确定.