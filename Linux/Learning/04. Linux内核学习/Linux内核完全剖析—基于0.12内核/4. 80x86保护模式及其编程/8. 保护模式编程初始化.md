- 4.8 保护模式编程初始化
    - 4.8.1 进入保护模式时的初始化操作
    - 4.8.2 模式切换

80X86 可以工作在几种模式下. 当机器上电或硬件复位时, 处理器工作实地址模式下, 并且从物理地址 OxFFFFFFF0 处开始执行软件初始化代码(通常在 EPROM 中). 软件初始化代码首先必须设置基本系统功能操作必要的数据结构信息, 例如处理中断和异常的实模式 IDT 表(即中断向量表). 如果处理器将仍然工作在实模式下, 那么软件必须加载操作系统模块和相应数据以允许应用程序能在实模式下可靠地运行. 如果处理器将要工作在保护模式下, 那么操作系统软件就必须加载保护模式操作必要的数据结构信息, 然后切换到保护模式.

## 1. 进入保护模式时的初始化操作

保护模式所需要的一些数据结构由处理器内存管理功能确定. 处理器支持分段模型可以使用从单个、统一的地址空间平坦模型到每个任务都具有几个受保护地址空间的高度结构化的多段模型. 分页机制能够用来部分在内存、部分在磁盘上的大型数据结构信息. 这两种地址转换形式都需要操作系统在内存中为内存管理硬件设置所要求的数据结构.

因此在处理器能够被切换到保护模式下运行之前, 操作系统加载和初始化软件(bootsect.s、 setup.s 和 head.s)必须在内存中先设置好保护模式下使用的数据结构的基本信息. 这些数据结构包括以下几种:

- 保护模式中断描述符表 IDT;
- 全局描述符表 GDT;
- 任务状态段 TSS;
- 局部描述符表 LDT;
- 若使用分页机制, 则起码需要设置一个页目录和一个页表;
- 处理器切换到保护模式下运行的代码段;
- 含有中断和异常处理程序的代码模块.

在能够切换到保护模式之前, 软件初始化代码还必须设置以下系统寄存器;

- 全局描述符表基地址寄存器 GDTR;
- 中断描述符表基地址寄存器 IDTR;
- 控制寄存器 CRI--CR3;

在初始化了这些数据结构、代码模块和系统寄存器之后, 通过设置 CRO 寄存器的保护模式标志 PE(位 0), 处理器就可以切换到保护模式下运行.

### 1.1 保护模式系统结构表

软件初始化期间在内存中设置的保护模式系统表主要依赖于操作系统将要支持的内存管理类型: 平坦的、平坦并支持分页的、分段的或者分段并支持分页的.

为了实现**无分页**的**平坦内存**模型, 软件初始化代码必须起码设置具有一个**代码段和一个数据段的 GDT 表**. 当然 GDT 表第 1 项还需要放置一个空描述符. **堆栈**可以放置在普通可读写**数据段**中, 因此并不需要专门的堆栈描述符. 支持**分页机制**的**平坦内存模型**还需要一个页目录和至少一个页表. 在可以使用 GDT 表之前, 必须使用 LGDT 指令将 GDT 表的基地址和长度值加载到 GDTR 寄存器中.

而**多段模型**则还需要用于操作系统的其他段, 以及用于每个应用程序的段和 LDT 表段. LDT 表的段描述符要求存放在 GDT 表中.

### 1.2 保护模式异常和中断初始化

**软件初始化**代码必须设置一个保护模式 IDT, 其中最少需要含有处理器可能产生的每个异常向量对应的门描述符. 若使用了**中断或陷阱门**, 那么门描述符可以都指向包含中断和异常过程的同一个**代码段**. 若使用**任务门**, 那么每个使用任务门的异常处理过程都需要一个**TSS 以及相关代码、数据和堆栈段**.

若允许**硬件中断**, 那么必须在 IDT 中为一个或多个中断处理过程设置门描述符.

在可以使用 IDT 之前, 必须使用 LIDT 指令将 IDT 表基地址和长度加载到 IDTR 寄存器中.

### 1.3 分页机制初始化

在设置 CR0 中的 PG 标志之前(启用分页机制), 必须先初始化以下数据结构和寄存器:

- 软件必须在物理内存中建立至少一个页目录和一个页表. 若页目录中含有指向自身的目录项时, 可以不使用页表. 此时, 页目录和页表被存放在同一个页面中.

- 将页目录表的物理基地址加载到 CR3 寄存器中(即 PDBR 寄存器).

- 处理器处于保护模式下, 若满足所有其他限制, 则 PG 和 PE 标志可以同时设置.

为保持兼容性, 设置 PG 标志(以及 PE 标志)时必须遵循以下规则:

- 设置 PG 标志的指令应该立即跟随一条 JMP 指令.

- 设置 PG 标志到跳转指令 JMP 之间的代码必须来自对等映射(即跳转之前的线性地址和开启分页后的物理地址相同)的一个页面上.

### 1.4 多任务初始化

若将要使用多任务机制, 并且/或者允许改变特权级, 那么软件初始化代码必须至少设置一个 TSS 以及相应的 TSS 段描述符(因为特权级 0、1 和 2 的各栈段指针需要从 TSS 中取得). 在创建 TSS 描述符时不要将其标注为忙, 该标志仅由处理器执行任务切换时设置. 与 LDT 段描述符相同, TSS 的描述符也存放在 GDT 中.

在处理器切换到保护模式后, 可以用 LTR 指令把 TSS 段描述符的选择符加载到任务寄存器 TR 中. 这个指令会把 TSS 标记成忙状态(B=1), 但是并不执行任务切换操作. 随后处理器可以使用这个 TSS 来定位特权级 0、1 和 2 的堆栈. 在保护模式中, 软件进行第一次任务切换之前必须首先加载 TSS 段的选择符, 因为任务切换会把之前任务状态复制到该 TSS 中.

在 LTR 指令执行后, 随后对任务寄存器的操作由任务切换进行. 与其他的段和 LDT 类似, TSS 段和 TSS 段描述符可以预先设置好, 也可在需要时设置.

## 2. 模式切换

进入保护模式, 软件通常不会再需要回到实地址模式. 为了还能运行为实地址模式编制的程序, 通常在虚拟-8086 模式中运行比再切换回实模式下运行更为方便.

### 2.1 切换到保护模式

切换到保护模式之前, 必须首先加载一些起码的系统数据结构和代码模块. 一旦建立这些系统表, 软件初始化代码就可以切换到保护模式中. 通过执行 CR0 寄存器中设置 PE 标志的 MOV CR0 指令, 就可以进行保护模式. (同一指令, CR0 的 PG 可用于开启分页)刚进入保护模式中运行, 特权级是 0. 为保证程序兼容性, 切换应该按照下面步骤进行:

1. 禁止中断. 使用 CLI 指令可以禁止可屏蔽硬件中断.  **NMI 会由硬件电路来禁止**, 同时软件应该确保在模式切换操作期间不产生异常和中断.

2. 执行 LGDT 指令把 GDT 表的基地址加载进 GDTR 寄存器.

3. 执行在控制寄存器 CRO 中设置 PE 标志(可选同时设置 PG 标志)的 MOV CRO 指令.

4. **在 MOV CRO 指令之后立刻执行一个远跳转 JMP 或远调用 CALL 指令**. 这个操作通常是远跳转到或远调用指令流中的下一条指令.

5. 若要使用局部描述符表, 则执行 LLDT 指令把 LDT 段的选择符加载到 LDTR 寄存器中.

6. 执行 LTR 指令, 用初始保护模式任务的段选择符或者可写内存区域的段描述符加载任务寄存器 TR. 这个可写内存区域用于在任务切换时存放任务的 TSS 信息.

7. 在进入保护模式后, 段寄存器仍然含有在实地址模式时的内容. 第 4 步中的 JMP 或 CALL 指令会重置 CS 寄存器. 执行以下操作之一可以更新其余段寄存器的内容: 其余段寄存器的内容可通过重新加载或切换到一个新任务来更新.

8. 执行 LIDT 指令把保护模式 IDT 表的基地址和长度加载到 IDTR 寄存器中.

9. 执行 STI 指令开启可屏蔽硬件中断, 并且执行必要的硬件操作开启 NMI 中断.

另外,  MOV CRO 指令之后紧接着的 JMP 或 CALL 指令会改变执行流. 如果开启了分页机制, 那么 MOV CRO 指令到 JMP 或 CALL 指令之间的代码必须来自对等映射(即跳转之前的线性地址与开启分页后的物理地址相同)的一个页面上. 而 JMP 或 CALL 指令跳转到的目标指令并不需要处于对等映射页面上.

### 2.2 切换回实地址模式

使用 MOV CRO 指令把控制寄存器 CRO 中的 PE 标志清 0. 重新进入实地址模式的过程应该按照以下步骤进行:

1. 禁止中断. 使用 CLI 指令可以禁正可屏蔽硬件中断.  NMI 会由硬件电路来禁止. 同时软件应该确保在模式切换操作期间不产生异常和中断

2. 如果己开启分页机制, 那么需要执行:

- 把程序的控制转移到对等映射的线性地址处(即线性地址等于物理地址).
- 确保 GDT 和 IDT 在对等映射的页面上.
- 清除 CRO 中的 PG 标志.
- CR3 寄存器置为 0x00, 用于刷新 TLB 缓冲.

3. 把程序的控制转移到长度为 64KB(OxFFFF)的可读段中. 这步操作使用实模式要求的段长度加载 CS 寄存器.

4. 使用指向含有以下设置值的描述符的选择符来加载 SS、 DS、 ES、 FS 和 GS 段寄存器.

- 段限长 Limit 一 64KB
- 字节颗粒度(G=O).
- 向上扩展 CE=O).
- 可写(W=l).
- 存在(P=l).

5. 执行 LIDT 指令来指向在 IMB 实模式地址范围内的实地址模式中断表.

6. 清除 CRO 中的 PE 标志来切换到实地址模式.

7. 执行一个远跳转指令跳转到一个实模式程序中, 这步会刷新指令队列并且为 CS 寄存器加载合适的基地址和访问权限值.

8. 加载实地址模式程序代码会使用的 SS、DS、FS 和 GS 寄存器.

9. 执行 STI 指令开启可屏蔽硬件中断, 并且执行必要的硬件操作开启 NMI 中断.