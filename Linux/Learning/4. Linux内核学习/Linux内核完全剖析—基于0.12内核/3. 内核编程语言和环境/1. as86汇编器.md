- 3.1　as86 汇编器

    - 3.1.1　as86 汇编语言语法

    - 3.1.2　as86 汇编语言程序

    - 3.1.3　as86 汇编语言程序的编译和链接

    - 3.1.4　as86 和 1d86 使用方法和选项

在 Linux 0.1x 中使用了两种汇编器(Assembler). 一种是能产生 16 位代码的 as86 汇编器, 使用配套的 ld86 链接器; 另一种是 GNU 的汇编器 gas(as), 使用 GNU ld 链接器来链接产生的目标文件.

as86 和 ld86 是 Intel 8086、80386 汇编编译程序和链接程序. Linux 仅用它来创建 16 位启动引导扇区程序 boot/bootsect.s 和实模式下初始设置程序 boot/setup.s 的位进制执行代码. 该编译器语法与 GNU as 汇编编译器语法不兼容, 更近似于微软的**MASM**、Borland 公司的**Turbo ASM**和**NASM**等汇编器语法. 这些汇编器都是使用了**Intel 的汇编语言语法**.

这个编译器和链接器的源码可以从网站 www.oldlinux.org 下载. 现代 Linux 可直接安装包含 as86/ld86 的软件包, 如**dev86-XXX.rpm**.

## 1. as86 汇编语言语法

汇编器专门用来把低级汇编语言程序编译成含机器码的二进制程序或目标文件. 汇编的命令行基本格式是:

```
as [选项] -o objfile srcfile
```

语句可以是只包含空格、制表符和换行符的空行, 也可以是赋值语句(或定义语句)、伪操作符语句和机器指令语句.

赋值语句用于给一个符号或标识符赋值.

伪操作符语句是汇编器使用的指示符, 它通常并不会产生任何代码. 它由伪操作符和 0 个或多个操作数组成. 每个操作码都由一个点字符"."开始. 点字符"."本身是一个特殊的符号, 它表示编译过程中的位置计数器. 其值是点符号出现处机器指令第 1 个字节的地址.

汇编器编译产生的目标文件 objfile 通常至少包含三个段或区(section). 即正文段(.text)、数据段(.data)和未初始化数据段(.bss).

- 正文段(或称代码段)是一个已初始化的段, 通常其中包含程序的执行代码和只读数据.

- 数据段也是一个已初始化过的段, 其中包含可读写的数据.

- 未初始化数据段是一个未初始化的段. 通常汇编器产生的输出目标文件中不会为该段保留空间, 但在目标文件链接成执行程序被加载时操作系统会把该段的内容全部初始化为 0.

在编译过程中, 汇编语言程序中会产生代码或数据的语句, 都会在这三个中的一个段中生成代码或数据. 编译产生的字节会从".text"段开始存放. 可以使用段控制伪操作符来更改写入的段.

## 2. as86 汇编语言程序

下面以一个简单的框架示例程序 boot.s 说明 as86 汇编程序的结构以及程序中语句的语法, 然后给出编译链接和运行方法, 最后分别列出 as86 和 ld86 的使用方法和编译选项.

```
1 !
2 ! boot.s  -- bootsect.S 的框架程序. 用代码 0x07 替换串 msg1 中 1 字符, 然后在屏幕第 1 行上显示.
3 !
4 .globl begtext,begdata,begbss,endtext,enddata,endbss   ! 全局标识符, 供 ld86 链接使用.
5 .text                           ! 正文段
6 begtext:
7 .data                           ! 数据段
8 begdata:
9 .bss                            ! 未初始化数据段
10 begbss:
11 .text                           ! 正文段
12 BOOTSEG = 0x07c0                ! BIOS 加载 bootsect 代码的原始段地址
13
14 entry start                     ! 告知链接程序, 程序从 start 标号处开始执行
15 start:
16         jmpi    go,BOOTSEG      ! 段间跳转. BOOTSEG 指出跳转段地址, 标号 go 是偏移地址
17 go:     mov     ax,cs           ! 段寄存器 cs 值-->ax, 用于初始化数据段寄存器 ds 和 es
18        mov     ds,ax
19         mov     es,ax
20         mov     [msg1+17],ah    ! 0x07-->替换字符串中 1 个点符号, 喇叭会鸣一声
21         mov     cx,#20          ! 共显示 20 个字符, 包括回车换行符
22         mov     dx,#0x1004      ! 字符串将显示在屏幕第 17 行、第 5 列处
23         mov     bx,#0x000c
24         mov     bp,#msg1
25         mov     ax,#0x1301
26         int     0x10
27 loop0:  jmp     loop0
28 msg1:   .ascii  "Loading system ..."
29         .byte   13,10
30 .org 510
31         .word   0xAA55
32 .text
33 endtext;
34 .data
35 enddata;
36 .bss
37 endbss;
```


