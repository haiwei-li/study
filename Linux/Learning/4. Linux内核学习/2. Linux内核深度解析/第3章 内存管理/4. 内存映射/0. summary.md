
内存映射是在**进程的虚拟地址空间**中创建**一个映射**, 分为以下两种.

(1) **文件映射**: 文件支持的内存映射, 把**文件的一个区间**映射到进程的虚拟地址空间, **数据源**是存储设备上的**文件**.

(2) **匿名映射**: 没有文件支持的内存映射, 把**物理内存**映射到进程的虚拟地址空间, **没有数据源**.

通常把**文件映射**的**物理页**称为**文件页**, 把**匿名映射**的**物理页**称为**匿名页**.

根据修改是否对其他进程可见和是否传递到底层文件, 内存映射分为共享映射和私有映射.

(1) **共享映射**: 修改数据时映射相同区域的其他进程可以看见, 如果是文件支持的映射, 修改会传递到底层文件.

(2) **私有映射**: 第一次修改数据时会从数据源复制一个副本, 然后修改副本, 其他进程看不见, 不影响数据源.

两个进程可以使用共享的文件映射实现共享内存. 匿名映射通常是私有映射, 共享的匿名映射只可能出现在父进程和子进程之间.

在进程的虚拟地址空间中, 代码段和数据段是私有的文件映射, 未初始化数据段、堆和栈是私有的匿名映射. 内存映射的原理如下.

(1) 创建内存映射的时候, 在进程的用户虚拟地址空间中分配一个虚拟内存区域.

(2) Linux 内核采用延迟分配物理内存的策略, 在进程第一次访问虚拟页的时候, 产生缺页异常. 如果是文件映射, 那么分配物理页, 把文件指定区间的数据读到物理页中, 然后在页表中把虚拟页映射到物理页; 如果是匿名映射, 那么分配物理页, 然后在页表中把虚拟页映射到物理页.