
# 设备中断发生

在**设备发生中断请求**时, 这就产生设备的 ISR(中断服务例程)是由**VMM(或 host OS)处理！！！**, 还是**直接由 VM(guest OS)处理**(或由**VMM 转发给 VM！！！**)的问题, 即**ISR**是**运行在 host**还是**guest 端**的问题.

依赖于 VMM 对**外部设备所有权**的设计产生**两种模型(！！！**):

- **设备**是属于**host 所有**, 物理设备的**ISR**由**VMM 来执行**.
- **设备**分配给**VM 使用**, 那么**ISR**将在**guest 环境**里运行.

**host**和**guest**都有自己的**IDT(中断描述符表**), host vector 对应物理设备 ISR 在 host IDT 的位置, 而 guest vector 对应着 VMM 反馈给 guest 的中断请求在 guest IDT 上的位置. **中断请求**通过**VMM**给**VM**使用**injection event(注入事件！！！**)的手段来实现.

# 2.1. 外部中断控制权在 guest 上

**host vector**和**guest vector**并**不相等**, 但在**设备分配给 VM**使用的模型里, 若**外部中断控制权在 guest**手上, 那么**guest vector**可以对应**物理设备 ISR 在 guest IDT**的位置, 也就是**物理设备 ISR 完全由 guest 执行**, 而**VMM 并不监管或转发**.

# 2.2. 外部中断控制权在 VMM 上

如果**外部中断的控制权**需要掌握在**VMM(即 host**)手中, 通过**开启"external\-interrupt exiting！！！**"功能, 并且结合"**acknowledge interrupt on exit"位！！！**的设置来实现. 当发生**外部中断**时, **VM 停止工作**, 处理器**控制权切换回 VMM**.

# 2.3. 外部设备所有权归 VMM

在**设备所有权归 VMM(！！！**)的模型里, **虚拟设备**产生了, 它是**VMM**在**物理设备之上抽象**出来的虚拟设备概念.

**中断发生**, **VMM 的 vector**是物理设备对应在**host IDT**里, **VMM**执行**物理设备的 ISR**. 然后**模拟 guest 的 ISR 处理流程**, 如发送 EOI 命令给中断控制器, 更新中断控制器状态. 根据**对应的 guest vector**注入一个**外部中断给 guest(！！！**)在自己的 IDT 找到 ISR 执行, 这个**guest ISR 可能并不能做实际收尾工作**, 如发送 EOI 命令(被 VMM 接管)或更新中断控制器.

**host vector**代表着来自**平台的物理设备**, 而**guest vector**代表来自**虚拟设备**, 这**两个 vector 值不一致**, 这个**虚拟设备由 VMM 维护**而代表着**物理设备在 VM 环境中的名字**. **虚拟设备**可能并**不存在实体功能**, 只是逻辑表述上的抽象概念.

# 2.4. 外部设备所有权归 VM

在**设备分配给 VM**使用的模型里, guest vector 与 host vector 可能一致也可能不一致, 但**物理设备的 ISR 由 guest**去运行, 代表着 ISR 的收尾工作由 guest 去执行. **VMM 截取中断请求**后根据**guest vector**, 同样使用**事件注入手段**转发外部中断给**guest 执行**, 而**VMM 可能并不做其他工作**. 这是在**host 夺取外部中断控制器**的前提下, 前面所述在**guest 掌控外部中断权**时, 设备 ISR 直接在 guest 中执行.

当然, **VMM 也可以不拦截外部中断(！！！**), 这样外部中断就直接通过 guest\-IDT 进行 deliver 执行, 而**不需要经过 VMM 转发**.
