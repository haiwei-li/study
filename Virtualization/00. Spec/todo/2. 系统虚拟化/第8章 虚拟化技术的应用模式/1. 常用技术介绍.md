
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [虚拟机的动态迁移](#虚拟机的动态迁移)
  - [什么是虚拟机的动态迁移](#什么是虚拟机的动态迁移)
  - [虚拟机动态迁移的特点](#虚拟机动态迁移的特点)
- [虚拟机快照](#虚拟机快照)
  - [什么是虚拟机快照](#什么是虚拟机快照)
  - [为什么要使用虚拟机快照](#为什么要使用虚拟机快照)
- [虚拟机克隆](#虚拟机克隆)
  - [什么是虚拟机克隆](#什么是虚拟机克隆)
  - [为什么需要虚拟机克隆](#为什么需要虚拟机克隆)
- [案例分析: VMware VMotion 和 VMware 快照](#案例分析-vmware-vmotion-和-vmware-快照)
  - [VMware VMotion](#vmware-vmotion)
  - [VMware 快照](#vmware-快照)

<!-- /code_chunk_output -->

# 虚拟机的动态迁移

## 什么是虚拟机的动态迁移

**迁移**, 分为**系统的迁移**和**工作的迁移**.

- **系统迁移**是指把**整个系统的软件**, 包括**操作系统**, 完全复制到另一个机器上;

- **工作迁移**是指把某台机器上的**一些工作转移到别的机器**上

先看看**传统的无虚拟机**和**有虚拟机的静态迁移**是什么样子的.

**无虚拟机**下的**系统迁移**是指在没有虚拟机的环境下把一台机器的所有软件, 包括所有状态都复制到另一台机器上. 这种迁移可以通过先做出**系统镜像**, 然后**复制**到其他机器上, 或通过硬盘互相复制的方式来实现迁移.

**无虚拟机**的**工作迁移**则需要**特殊的系统支持**, 如哥伦比亚大学的 Zap 系统, 通过在操作系统上实现一层薄的虚拟层, 实现工作的**实时迁移**.

虚拟机的静态迁移指在关闭虚拟机的情况下, 使用文件传输软件将虚拟机的镜像传输到另外的机器上, 然后启动虚拟机. 此种情况下, 不能实现工作的迁移.

最后看看有虚拟机的动态迁移, 所谓虚拟机的**动态迁移**, 是指在**虚拟机运行**的情况下, **实时将虚拟机 1 迁移到另一个虚拟机 2**. 具体讲, 就是将**物理服务器 A**上的**内存**里的**所有关于虚拟机 1 的信息**全部**封包通过网络移交到物理服务器 B**上, 从而**形成新的虚拟机 2**. 这是一个内存信息的移交与转换的过程, 速度快, 其唯一限制就是网络带宽与突然停电之类的突发情况. 这种模式下, 如果**VMM 只把某些工作的信息**传送给**其它虚拟机**中, 则可以实现**工作的实时迁移**.

## 虚拟机动态迁移的特点

虚拟机的动态迁移具有如下优点

1) 在**非停机情况**下进行**迁移**, 可实现**在线的系统维护**, 提高系统的**可维护性**, 优化系统中的**资源分配**, 以及通过将**不正常工作的宿主机**的工作迁移到**正常工作的宿主机**中实现**高可用性**

2) 前面提到, 虚拟化去掉了硬件的相关性, 从而实现不同硬件上的虚拟机之间的动态迁移, 极大扩大了可迁移的面, 使虚拟机的动态迁移在实用性方面较之以前的方法有很大进步.

3) 虚拟机通常将硬件资源抽象成一个或一些文件, 极大简化了虚拟机之间迁移的配置过程, 更进一步, 虚拟机之间的迁移还可以通过配置管理工具自行进行管理, 提高了系统的可维护性.

4) 通过迁移管理工具, 可详细记录迁移, 保持追踪, 从而在出问题时候有依据.

还可以指定某一时刻进行迁移工作.

# 虚拟机快照

## 什么是虚拟机快照

就是将**某一个时刻**虚拟机的**状态**像照片一样保存下来. 通常, 快照将要保存所有的**硬盘信息**、**内存信息！！！**和**CPU 信息**, VMware 还将保存 BIOS 信息.

## 为什么要使用虚拟机快照

虚拟机快照用在很多地方, 包括测试、备份和安全等.

测试, 想测试一个新软件, 并不知道软件将会对系统产生什么影响. 在测试之前做过快照, 有问题只需要回滚到快照之前.

备份, 可定期做虚拟机快照并将快照产生的文件保存在备份盘上面. 听起来类似于 Ghost 备份, 但使用虚拟机的快照有以下优点:

1) 备份可以由虚拟机管理工具实现, 可定时备份等.

2) 通常 Ghost 备份会复制所有文件, 所以生成的备份文件非常大, 而虚拟机有自身的文件格式, 可以生成**增量的文件备份**, 使备份文件显著减少

3) 因为虚拟机快照很好保存了当前虚拟机的运行状态, 这些运行的状态可为程序调试提供很好信息

# 虚拟机克隆

## 什么是虚拟机克隆

指将一个系统的状态完全不变的复制到另外一个系统上, 形成两个完全相同的系统, 这里的相同指的是操作系统及应用程序的相同.

由于 VMM 中维护的信息可能是有所不同, 并且如果从物理机到虚拟机的克隆也可能会有设备上的改动, 两个系统的运行环境也就可能不同. 虚拟机的克隆主要分为两种: 虚拟机到虚拟机的克隆和物理机到虚拟机的克隆.

虚拟机到虚拟机的克隆, 分为静态克隆和动态克隆, 静态克隆即将虚拟机的状态用快照技术保存下来, 将保存下来的镜像复制到其它机器. 动态克隆即通过网络, 同步地将所有的状态迁移到其它的虚拟机上. 此种方法有点在于可同时对 N 台虚拟机进行克隆操作; 缺点在于此间如果断电, 被克隆的机器将进入不可预计状态.

物理机到虚拟机的克隆, 此种克隆只能使用静态克隆, 因为物理机不具备动态迁移能力. 当需要从一台物理机迁移到虚拟机时候, 虚拟机将会首先虚拟出和物理机相同的硬件(同样的 CPU、内存和硬盘等), 然后通过迁移工具将物理机上的状态全部克隆到虚拟机上.

这个功能很重要, 原因主要两点.

1) 此种克隆不用重装 OS, 不用重装任何软件, 传统的系统可以非常方便移植到当前虚拟机上,

2) 当需要在虚拟环境下测试物理机上已装好的软件时, 可将此系统克隆到虚拟机中进行测试.

## 为什么需要虚拟机克隆

利用虚拟机克隆技术, 只需要先安装并配置好一台虚拟机, 然后克隆到到其它数万台机器上, 从而大大降低时间.

# 案例分析: VMware VMotion 和 VMware 快照

## VMware VMotion

动态迁移中只需要着重处理以下三个类的状态.

- 虚拟设备的状态, 例如 CPU、主板、网络、存储设备和显卡适配器等.
- 外部设备的状态, 例如网络、USB 设备和 SCSI 存储设备等.
- 虚拟机内存.

实际迁移中, 一共包括 5 个步骤

1) 初始化动态迁移, 即选择哪个虚拟机需要迁移, 其目标机器是哪个.

2) **虚拟机继续在源主机上运行**, 与此同时, 该**虚拟机的内存**被**提前**传输到**目标机器上缓存**起来. 该步骤可能执行多次, 在**第一次循环后**, 后面的几次循环**只需要将被改变的内存**传输过去, 以**减少时间的损耗**.

3) **停止虚拟机的运行**, 把当前虚拟机的**非内存状态**, 例如 CPU 状态, 传送到目标机器.

4) 把虚拟机的控制权转移到**目标机器**并**重新启动虚拟机**运行.

5) 把在**停止虚拟机运行时**没有传输到目标机器的**内存传输过去**, 并在源端销毁虚拟机相关的信息, 释放资源.

虚拟机动态迁移过程中有几个地方需要特殊处理, 包括网络、磁盘设备还有物理内存.

1. 网络

在虚拟机迁移中, 由于虚拟机从一个物理机迁移到另一台, 其网络设备面临一个挑战: 原来打开的网络连接在迁移后也是连接着的. VMware ESX Server 使用虚拟网络架构技术(Virtual Network Architecture)解决这个问题.

在这个架构中, 每个虚拟机都有自己的虚拟网络网卡(Virtual Ethernet Network Interface Card, VNIC), 每个 VNIC 有自己 MAC 地址来标识本地网络. 而每个 VNIC 都被连接到虚拟机监控器管理的物理网卡上(NIC). 由于每个 VNIC 拥有自己独立的 MAC 地址, 虚拟机就可以随意地在同一个子网中的各个物理机间穿梭, 而不用担心网络连接会断开.

其它类似产品, 例如 Xen, 也是类似技术.

2. 磁盘设备

动态迁移相关资源都存储在网络磁盘服务上.

3. 物理内存

在虚拟机动态迁移中, 物理内存是所有状态中内容最庞大的部分. 先将虚拟机挂起来再传递所有页面显然严重影响执行效率.

VMware 采用影子页方式为各个虚拟机提供虚拟的物理内存(影子页表技术见前面). 动态迁移时候, 大部分的页面会被预复制(Pre\-Copy)到目标物理机上. 第一次复制会将所有页面复制过去. 在每张页面被复制前, 它都会标记为只读, 一旦在预复制期间这个页被写, 虚拟机监控器会立即发现. 在**第一次预复制！！！循环后**的**后续预复制！！！循环**中, 只有被修改的页面会被再次发送过去. 当达到**某个条件**后, 例如**预复制循环次数**达到**预设的最大次数**, 上一次**预复制循环中**被修改页的数量小于预设值等, 预复制过程终止, 进入下一个迁移步骤.

## VMware 快照


