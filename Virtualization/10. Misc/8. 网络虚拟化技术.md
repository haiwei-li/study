
当越来越多**不同性质的虚拟机**运行在**同一台物理机**上时, 它们的**进出数据**都**不加区分**地拥挤在**一个 I/O 通道**上显然是不合理的. **上层业务**对**网络的需求**除了基本的**数据转发**之外, 还必须包括**安全隔离**和 **QoS(服务质量保证**).

实现这两点的**关键**在于要**对数据流量**进行**清晰的区分**, 只有区分出不同的流量才能根据业务类型配以不同的保障等级. 以物理机出口为界, 我们可以将**数据流过的路径**划分为**外部**和**内部**两部分.

- 对于**物理机外部网络**, 以 Cisco 为首的网络厂家提出了**VN-Tag**等解决方案. 通过在**全网部署 VN-Tag**, **不同虚拟机的流量**能够被识别, 从而在**上联交换机**上能够更好地实现**QoS**和**安全隔离**. 这就是所谓的"**虚拟接入**".

- 对于**物理机内部**, **虚拟化网卡**需要在**不破坏现有业务机制**的前提下, 为**每个虚拟机**提供一个**模拟真实的物理通道**, **每个通道**具备**独立的 I/O 功能**, 可以重现在非虚拟化环境中的一切网络机制, 并且对虚拟机透明. 这就是所谓的"**虚拟通道**".

**虚拟化网卡**的关键技术就是"**虚拟接入**"和"**虚拟通道**". 虚拟化网卡的基本原理如图 2-18 所示.

图 2-18 虚拟化网卡的基本原理:

![](./images/2019-07-03-15-18-45.png)

由图 2-18 可知, **虚拟机**产生的**数据**通过**独立的通道进入网卡**, 然后被**打上标签**送往**外部网络**; 同理, **网卡接收**到**外部网络**送来的**带有标签的数据**, 然后**根据标签**将数据送往**相应的虚拟机信道**. 于是, 上层的业务丝毫感受不到 I/O 的变化, 所有的数据行为与运行在一台独立的物理机上没有区别.

- "**虚拟接入**"是**利用标签**, 在**全网范围**内**区分**出**不同的虚拟机流量**;

- "**虚拟通道**"是在**物理网卡**上对**上层软件系统**虚拟出**多个物理通道**, **每个通道**具备**独立的 I/O 功能**.

本节将对 SR-IOV—这个影响力最大的**虚拟通道技术**进行深入介绍.

SR-IOV(Single Root I/O Virtualization)是 PCI-SIG 推出的一项标准, 它将**单个 PCIe 设备**对上层软件**虚拟化**为**多个独立的 PCIe 设备**. SR-IOV 网卡能对上层操作系统虚拟化出多个 PCIe 网卡, 而且**虚拟出的每个网卡**都可以实现**独立的 I/O 功能**. 独立的通道能够实现更强的安全隔离、更完善的 QoS 和更高的传输效率. SR-IOV 目前支持在**一块 PCIe 网卡**上虚拟化出**256 个通道**, 其原理如图 2-19 所示.

图 2-19 SR-IOV 原理图:

![](./images/2019-07-03-15-20-31.png)

SR-IOV **虚拟出的通道**有两种:

- PF(Physical Function), PF 是一个**完整的 PCIe 设备**, 包含**全面的管理、配置功能**, Hypervisor 往往通过 PF 来实现对网卡**所有 I/O 资源**的管理和配置
- 和 VF(Virtual Function), VF 是一个简化的 PCIe 设备, **仅仅包含了 I/O 功能**, **不能**通过 VF 管理物理网卡.

**所有的 VF**都是通过 PF 衍生而来的, 一块 SR-IOV 网卡最多可以生成 256 个 VF. VF 可以理解为物理网卡硬件资源的一个切片, 在虚拟化软件平台 Hypervisor 看来, VF 与普通的 PCIe 网卡一模一样, 安装相应的驱动后就能直接使用. 如果一台物理机上只有一个单端口的 SR-IOV 网卡, 这个端口产生了 6 个 VF, 则 Hypervisor 就能得到**6 个以太网连接**.

由于**管理**网卡的**I/O 资源**和**生成 VF**都需要**使用 PF**, 而且 Hypervisor 需要具备区分 PF 和 VF 的能力才能实现对网卡的正确配置. 所以, SR-IOV 的实现需要依赖**硬件**和**软件**两部分, 即 SR-IOV 需要**专门的网卡芯片**和 **BIOS 版本**, 也需要上层 Hypervisor 安装相应的驱动.

在 SR-IOV 的基础上, 再结合 Intel VT-d 或 AMD IOMMU 技术, 可以实现 VM 和 VF 的一对一映射, 进而跳过 Hypervisor 的软件交换机使 VM 直接访问 VF 硬件资源. 这样既能提高访问效率, 又能提高网卡的利用率.

