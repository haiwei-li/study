
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 物理机器和 VMM](#1-物理机器和-vmm)
- [2. 虚拟环境的管理](#2-虚拟环境的管理)
  - [2.1. 虚拟资源](#21-虚拟资源)
  - [2.2. 虚拟环境的调度](#22-虚拟环境的调度)
  - [2.3. 虚拟机间通信机制](#23-虚拟机间通信机制)
  - [2.4. 虚拟化环境的管理接口](#24-虚拟化环境的管理接口)
- [3. 物理资源的管理](#3-物理资源的管理)
  - [3.1. 处理器管理](#31-处理器管理)
  - [3.2. 内存管理](#32-内存管理)
  - [3.3. 中断管理](#33-中断管理)
  - [3.4. 系统时间维护](#34-系统时间维护)
  - [3.5. 设备管理](#35-设备管理)
- [4. 其它模块](#4-其它模块)
  - [4.1. 软件定时器](#41-软件定时器)
  - [4.2. 多处理器同步原语(spinlock、rcu 等)](#42-多处理器同步原语spinlock-rcu-等)
  - [4.3. 调试手段(包括系统级别和虚拟环境待定)](#43-调试手段包括系统级别和虚拟环境待定)
  - [4.4. 性能采集与分析工具](#44-性能采集与分析工具)
  - [4.5. 安全机制](#45-安全机制)
  - [4.6. 电源管理](#46-电源管理)

<!-- /code_chunk_output -->

# 1. 物理机器和 VMM

从软件角度看, **物理**机器是由**处理器**、**内存**和**I/O 设备**等一组资源构成的实体. 虚拟机也一样, 由**虚拟处理器**、**虚拟内存**和**虚拟 I/O 设备**等组成.

**VMM** 基本上可以分为两部分: **虚拟环境的管理**和**物理资源的管理**. 前一部分是所有 VMM 产品需要提供的基本功能, 后一部分根据实现结构的差异, 也各有差异.

# 2. 虚拟环境的管理

## 2.1. 虚拟资源

VMM 需要提供如下基本模块.

1) 处理器虚拟化模块. 为虚拟机提供虚拟处理器.

2) 内存虚拟化模块. 为虚拟机提供虚拟内存

3) 设备虚拟化模块. 为虚拟机提供虚拟 I/O 设备.

## 2.2. 虚拟环境的调度

操作系统调度的单位是进程/线程, VMM 调度的调度单位是虚拟处理器.

当**虚拟处理器**被调度到时, **VMM 调度程序**负责将**虚拟处理器上下文**装载到**物理处理器**上, 然后**虚拟处理器**所对应的**客户机指令**开始真正被执行.

当**时间片用完**或**虚拟处理器主动让出**, **调度程序被触发**. 调度程序根据调度策略, 挑选**下一个虚拟处理器**继续运行.

VMM 调度策略可以有多种, 例如平均分配时间片, 或按照虚拟机权重等.

## 2.3. 虚拟机间通信机制

与 OS 中进程间通信类似, 虚拟环境下也存在**虚拟机间通信机制**. 虚拟机间通信机制为虚拟机互相通信的手段. 比如, **类虚拟化 I/O**中是基于**事务**的模型, 一个**I/O 事务**需要**特权虚拟机**和**正常虚拟机**共同合作完成, 中间就会大量用到虚拟机间通信.

虚拟机间通信机制从**实现上很多**. 通常来讲, **VMM**实现虚拟机间的通信机制, 并向虚拟机**提供相应的 API**. **虚拟机的客户 OS**通过调用这些 API 与其他虚拟机通信. 这些 API 可以是**事件通知**, 也可以是**共享内存**等.

VMM 还提供了**虚拟机**与**VMM**之间交互的 API.

## 2.4. 虚拟化环境的管理接口

**虚拟机的管理功能**由**上层的管理程序**和**VMM 提供的管理接口**组成.

- VMM 提供一组完备的管理接口, 来支持虚拟环境的创建、删除、暂停、查询和迁移等功能.

- 上层的管理程序则通过调用 VMM 提供的管理接口, 为用户提供管理界面

# 3. 物理资源的管理

与 OS 一样, VMM 本身承担全部或部分物理资源管理角色.

## 3.1. 处理器管理

包括

- 系统启动时**检测并获取所有的处理器**;

- 对**每个处理器进行初始化**, 如设置运行模式、设置页表、设置中断处理函数等;

- 将**所有处理器**纳入**调度序列**, 由调度程序对处理器进行调度.

有些**VMM**还支持对物理处理器的热插拔. 有些 VMM 还具有高可靠性的支持, 当收到处理器失效通知时, 如 MCA(Machine Check Abort), VMM 将其做热拔出处理.

## 3.2. 内存管理

包括

- 系统启动时 VMM 检测并获取内存;

- 对获得的内存的初始化, 包括分页并设置页表等;

- 提供内存分配接口, 以便 VMM 的其它模块能获得/释放内存;

- 给虚拟机分配内存, 并维护虚拟机物理地址与实际物理地址的映射关系, 以供 VMM 其它模块查询使用.

## 3.3. 中断管理

VMM 负责初始化并设置中断相关资源, 如处理器中断向量表、Local APIC 和中断控制器(I/O APIC、8259 PIC). 当中断发生后, VMM 是接收者, 它会根据中断的来源, 或直接处理, 或转发到相应特权虚拟机来处理.

## 3.4. 系统时间维护

VMM 拥有和时间相关的硬件资源, 因此 VMM 负责维护系统时间, 并向各虚拟机提供虚拟化的时间.

## 3.5. 设备管理

Hypervisor 模型中, 所有外设都属于 VMM, 因此, VMM 需要包含所有设备的驱动程序来管理这些设备. 混合模型下, 大部分外设属于特权客户操作系统, 由特权客户 OS 的驱动程序来管理这些外设. VMM 也拥有少部分的设备, 如用于调试的串口, 因此也需要包含这些设备的驱动程序.

# 4. 其它模块

VMM 通常还包括以下功能模块

## 4.1. 软件定时器

通常是通过时钟中断处理函数来实现的, 在 VMM 中广泛使用, 如系统时间的维护等.

## 4.2. 多处理器同步原语(spinlock、rcu 等)

与 OS 一样, 当多处理器共享同一个资源时, VMM 需要提供同步原语来同步多处理器的读写访问.

## 4.3. 调试手段(包括系统级别和虚拟环境待定)

printk 是最简单的调试手段, 有些还会开发其他调试工具

## 4.4. 性能采集与分析工具

VMM 通常也会提供 profiling 工具, 用于性能数据的采集和分析. 这些能采集 VMM 的全局的性能数据, 也能采集针对某个虚拟机的性能数据.

## 4.5. 安全机制

VMM 要保证各个虚拟机之间, 以及虚拟机与 VMM 之间是隔离的.

## 4.6. 电源管理

包括处理器电源管理、睡眠状态电源管理等.



