- [1. 环境变量](#1-环境变量)
- [2. 下载](#2-下载)
- [3. qemu](#3-qemu)
- [4. 交叉编译](#4-交叉编译)
- [5. 制作根文件系统](#5-制作根文件系统)
  - [5.1. 生成配置文件](#51-生成配置文件)
  - [5.2. 编译安装](#52-编译安装)
  - [5.3. 制作](#53-制作)
- [6. 编译 Dom0 Linux Kernel](#6-编译-dom0-linux-kernel)
- [7. 运行虚拟机](#7-运行虚拟机)
- [8. 配置并编译 Uboot](#8-配置并编译-uboot)
- [9. 编译 Xen Hypervisor](#9-编译-xen-hypervisor)
- [10. 生成设备树 blob](#10-生成设备树-blob)
- [11. 运行 Qemu Xen Dom0 Linux](#11-运行-qemu-xen-dom0-linux)
- [12. 运行 Qemu Xen Dom0 Linux 和 Dom1 Linux](#12-运行-qemu-xen-dom0-linux-和-dom1-linux)
  - [12.1. Dom0 和 Dom1 使用同一个 Linux 内核映像](#121-dom0-和-dom1-使用同一个-linux-内核映像)
  - [12.2. Dom0 和 Dom1 使用不同的 Linux 内核映像](#122-dom0-和-dom1-使用不同的-linux-内核映像)

# 1. 环境变量

```
export WORK_DIR=/data1/lihaiwei/XenOnArm
mkdir -pv $WORK_DIR
export BUILD_DIR=/data1/lihaiwei/XenOnArm/build
mkdir -pv $BUILD_DIR/busybox_arm64
cd $WORK_DIR
```

# 2. 下载

依赖安装:

```
sudo apt-get install git-email
sudo apt-get install libaio-dev libbluetooth-dev libbrlapi-dev libbz2-dev
sudo apt-get install libcap-dev libcap-ng-dev libcurl4-gnutls-dev libgtk-3-dev
sudo apt-get install libibverbs-dev libjpeg8-dev libncurses-dev libnuma-dev
sudo apt-get install librbd-dev librdmacm-dev
sudo apt-get install libsasl2-dev libsdl1.2-dev libseccomp-dev libsnappy-dev libssh2-1-dev
sudo apt-get install libvde-dev libvdeplug-dev libvte-2.91-dev libxen-dev liblzo2-dev
sudo apt-get install valgrind xfslibs-dev
sudo apt-get install libnfs-dev libiscsi-dev
```

# 3. qemu

下载 qemu 并编译

```
./configure --target-list=aarch64-softmmu
make -j4
```

可以静态编译

```
./configure --static --target-list=aarch64-softmmu
make -j4
```

./configure --target-list=aarch64-softmmu --enable-trace-backends=simple,log --disable-werror --static --enable-linux-aio --disable-xkbcommon --disable-libudev --disable-sdl --disable-gtk --disable-kvm --disable-tools LDFLAGS="-L/usr/lib"

# 4. 交叉编译

安装交叉编译工具

```
sudo apt install gcc-aarch64-linux-gnu
```

下载 Xen, Linux Kernel, Busybox, UBoot

```
git clone https://github.com/xen-project/xen.git

git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

git clone https://github.com/mirror/busybox.git

git clone https://github.com/u-boot/u-boot.git
```

# 5. 制作根文件系统

## 5.1. 生成配置文件

```
cd $WORK_DIR/busybox
make O=$BUILD_DIR/busybox_arm64/ ARCH=arm CROSS_COMPILE=aarch64-linux-gnu-  defconfig
make O=$BUILD_DIR/busybox_arm64/ ARCH=arm CROSS_COMPILE=aarch64-linux-gnu- menuconfig
```

选择下面的

```
Build BusyBox as a static binary
Don't use /usr
```

## 5.2. 编译安装

```
make -j4 O=$BUILD_DIR/busybox_arm64/ ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
make install O=$BUILD_DIR/busybox_arm64/ ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
```

## 5.3. 制作

```
cd $BUILD_DIR/busybox_arm64/_install/

$ ls
bin  linuxrc  sbin

mkdir proc sys dev etc etc/init.d

$ ll
total 32
drwxrwxr-x  8 lihaiwei lihaiwei 4096 2 月  25 14:33 ./
drwxrwxr-x 32 lihaiwei lihaiwei 4096 2 月  25 14:31 ../
drwxrwxr-x  2 lihaiwei lihaiwei 4096 2 月  25 14:31 bin/
drwxrwxr-x  2 lihaiwei lihaiwei 4096 2 月  25 14:33 dev/
drwxrwxr-x  3 lihaiwei lihaiwei 4096 2 月  25 14:33 etc/
lrwxrwxrwx  1 lihaiwei lihaiwei   11 2 月  25 14:31 linuxrc -> bin/busybox*
drwxrwxr-x  2 lihaiwei lihaiwei 4096 2 月  25 14:33 proc/
drwxrwxr-x  2 lihaiwei lihaiwei 4096 2 月  25 14:31 sbin/
drwxrwxr-x  2 lihaiwei lihaiwei 4096 2 月  25 14:33 sys/
```

在 `$BUILD_DIR/busybox_arm64/_install/etc/init.d/` 目录下新创建一个叫 rcS 的文件, 并且写入如下内容:

```
#!/bin/sh
export PATH=/sbin:/usr/sbin:/bin:/usr/bin

mkdir -p /proc
mkdir -p /tmp
mkdir -p /sys
mkdir -p /mnt

/bin/mount -a
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts
mount -t proc none /proc
mount -t sysfs none /sys

echo /sbin/mdev > /proc/sys/kernel/hotplug
/sbin/mdev -s
```

需要给执行权限

```
chmod a+x etc/init.d/rcS
```

打包 initramfs:

```
cd _install
find . | cpio -o --format=newc > ../rootfs.img
cd ..
gzip -c rootfs.img > rootfs.img.gz
cp rootfs.img.gz $BUILD_DIR/busybox_arm64/
```

# 6. 编译 Dom0 Linux Kernel

```
make O=$BUILD_DIR/linux_arm64/ ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
```

在生成的 `.config` 文件中添加下面两个选项 (默认情况下这两个选项已经设置):

```
CONFIG_XEN=y
CONFIG_XEN_DOM0=y
```

编译内核, 并复制生成的内核映像到指定的目录

```
make -j128 O=$BUILD_DIR/linux_arm64/ ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
cp ./arch/arm64/boot/Image.gz $BUILD_DIR/busybox_arm64/
cp ./arch/arm64/boot/Image $BUILD_DIR/busybox_arm64/
```

* `Image`: 通用的 Linux 内核二进制映像文件.

* `Image.gz`: Image 的 gzip 格式的压缩文件.

# 7. 运行虚拟机

```
./qemu-system-aarch64 \
-machine virt,gic_version=3 \
-machine virtualization=true \
-cpu cortex-a57 \
-machine type=virt \
-m 4096 \
-smp 4 \
-kernel ./Image.gz \
-nographic \
-no-reboot \
-initrd ./rootfs.img.gz \
-append "rw root=/dev/ram rdinit=/sbin/init earlyprintk=serial,ttyAMA0 \
console=ttyAMA0"
```

如下:

```
[    0.648875] hw perfevents: enabled with armv8_pmuv3 PMU driver, 7 counters available
[    0.656235] NET: Registered PF_PACKET protocol family
[    0.657098] 9pnet: Installing 9P2000 support
[    0.657363] Key type dns_resolver registered
[    0.669321] Timer migration: 1 hierarchy levels; 8 children per group; 1 crossnode level
[    0.670785] registered taskstats version 1
[    0.671731] Loading compiled-in X.509 certificates
[    0.687072] input: gpio-keys as /devices/platform/gpio-keys/input/input0
[    0.691765] clk: Disabling unused clocks
[    0.692012] PM: genpd: Disabling unused power domains
[    0.692287] ALSA device list:
[    0.692403]   No soundcards found.
[    0.770221] Freeing unused kernel memory: 10048K
[    0.771452] Run /sbin/init as init process
mount: can't read'/etc/fstab': No such file or directory
/etc/init.d/rcS: line 15: can't create /proc/sys/kernel/hotplug: nonexistent directory

Please press Enter to activate this console.
~ # uname -a
Linux (none) 6.9.0 #1 SMP PREEMPT Tue Feb 25 15:36:27 CST 2025 aarch64 GNU/Linux
~ # ls -l /
total 0
drwxrwxr-x    2 1004     1004             0 Feb 25 06:31 bin
drwxrwxr-x    7 1004     1004             0 Feb 26 13:18 dev
drwxrwxr-x    3 1004     1004             0 Feb 25 06:33 etc
lrwxrwxrwx    1 1004     1004            11 Feb 25 06:31 linuxrc -> bin/busybox
drwxr-xr-x    2 0        0                0 Feb 26 13:18 mnt
dr-xr-xr-x  122 0        0                0 Feb 26 13:18 proc
drwx------    2 0        0                0 Feb 25 07:35 root
drwxrwxr-x    2 1004     1004             0 Feb 25 06:31 sbin
dr-xr-xr-x   13 0        0                0 Feb 26 13:18 sys
drwxr-xr-x    2 0        0                0 Feb 26 13:18 tmp
~ #
```

这一步可以验证, 我们制作的 Linux Kernel 和 rootfs.img.gz 根文件系统可以工作.

# 8. 配置并编译 Uboot

```
make O=$BUILD_DIR/uboot_arm64/ CROSS_COMPILE=aarch64-linux-gnu- qemu_arm64_defconfig
```

两个配置项添加到 `.config` 文件

```
CONFIG_ARCH_QEMU=y
CONFIG_TARGET_QEMU_ARM_64BIT=y
```

编译:

```
make O=$BUILD_DIR/uboot_arm64/ CROSS_COMPILE=aarch64-linux-gnu- -j128
```

启动 Uboot, 并通过 Uboot 加载 Linux Kernel:

```
./qemu-system-aarch64 \
-machine virt,gic_version=3 \
-machine virtualization=true \
-cpu cortex-a57 \
-machine type=virt \
-m 512M \
-bios ./u-boot.bin \
-device loader,file=./Image,addr=0x45000000 \
-nographic -no-reboot \
-chardev socket,id=qemu-monitor,host=localhost,port=7777,server=on,wait=off,telnet=on \
-mon qemu-monitor,mode=readline
```

Uboot 执行效果如下:

```
U-Boot 2025.01 (Mar 01 2025 - 14:55:58 +0800)

DRAM:  512 MiB
Core:  51 devices, 14 uclasses, devicetree: board
Flash: 64 MiB
Loading Environment from Flash... *** Warning - bad CRC, using default environment

In:    serial,usbkbd
Out:   serial,vidconsole
Err:   serial,vidconsole
No USB controllers found
Net:   eth0: virtio-net#32

starting USB...
No USB controllers found
Hit any key to stop autoboot:  0
Scanning for bootflows in all bootdevs
Seq  Method       State   Uclass    Part  Name                      Filename
---  -----------  ------  --------  ----  ------------------------  ----------------
Scanning global bootmeth 'efi_mgr':
Cannot persist EFI variables without system partition
Missing TPMv2 device for EFI_TCG_PROTOCOL
Missing RNG device for EFI_RNG_PROTOCOL
Scanning bootdev 'fw-cfg@9020000.bootdev':
fatal: no kernel available
No USB controllers found
scanning bus for devices...
BOOTP broadcast 1
DHCP client bound to address 10.0.2.15 (1 ms)
Scanning bootdev 'virtio-net#32.bootdev':
BOOTP broadcast 1
DHCP client bound to address 10.0.2.15 (0 ms)
*** Warning: no boot file name; using '0A00020F.img'
Using virtio-net#32 device
TFTP from server 10.0.2.2; our IP address is 10.0.2.15
Filename '0A00020F.img'.
Load address: 0x40400000
Loading: *
TFTP error: 'Access violation' (2)
Not retrying...
No more bootdevs
---  -----------  ------  --------  ----  ------------------------  ----------------
(0 bootflows, 0 valid)
=>
```

注: 这里使用的是未压缩的 Kernel 二进制映像.

在 Uboot 的命令行终端中, 输入下面的命令:

```
booti 0x45000000 - 0x40000000
```

Kernel 启动效果如下:

```
[    0.472588] ALSA device list:
[    0.472718]   No soundcards found.
[    0.476678] /dev/root: Can't open blockdev
[    0.477296] VFS: Cannot open root device "" or unknown-block(0,0): error -6
[    0.477526] Please append a correct "root=" boot option; here are the available partitions:
[    0.477868] 1f00          131072 mtdblock0
[    0.477927]  (driver?)
[    0.478157] List of all bdev filesystems:
[    0.478281]  ext3
[    0.478294]  ext2
[    0.478356]  ext4
[    0.478417]  squashfs
[    0.478478]  vfat
[    0.478552]
[    0.478757] Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
[    0.479134] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 6.9.0 #1
[    0.479370] Hardware name: linux,dummy-virt (DT)
[    0.479622] Call trace:
[    0.479774]  dump_backtrace+0x94/0xec
[    0.480236]  show_stack+0x18/0x24
[    0.480361]  dump_stack_lvl+0x38/0x90
[    0.480485]  dump_stack+0x18/0x24
[    0.480595]  panic+0x35c/0x3c8
[    0.480698]  mount_root_generic+0x1dc/0x300
[    0.480836]  mount_root+0x164/0x2a4
[    0.480953]  prepare_namespace+0x70/0x298
[    0.481079]  kernel_init_freeable+0x268/0x2a8
[    0.481217]  kernel_init+0x20/0x128
[    0.481330]  ret_from_fork+0x10/0x20
[    0.481654] Kernel Offset: 0x39514c200000 from 0xffff800080000000
[    0.481846] PHYS_OFFSET: 0xfff0ea4dc0000000
[    0.481987] CPU features: 0x4,40001009,e0100000,4200421b
[    0.482296] Memory Limit: none
[    0.482633] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0) ]---
```

注: `0x45000000` 是我们上面制作的 **内核映像的地址**, `0x40000000` 是 **Qemu 设备树 blob 的默认地址**. 由于我们没有在上面的命令中指定根文件系统 `root.img.gz`, 所以 Linux kernel 加载 root fs 时失败了, 这是可预期的行为.

这里我们可以验证, 我们编译的 Uboot 可以正常引导 Linux kernel 映像.

# 9. 编译 Xen Hypervisor

```
make O=$BUILD_DIR/xen_arm64/ dist-xen XEN_TARGET_ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
```

注: 编译时若报错:`error: taking address of packed member of 'struct <anonymous>' may result in an unaligned pointer value`, 则修改 xen/Rules.mk 文件, 去掉 - Werror.

# 10. 生成设备树 blob

```
./qemu-system-aarch64 \
-machine virt,gic_version=3 \
-machine virtualization=true \
-cpu cortex-a57 \
-machine type=virt \
-m 4096 \
-smp 4 \
-display none \
-machine dumpdtb=virt-gicv3.dtb
```

输出:

```
qemu-system-aarch64: info: dtb dumped to virt-gicv3.dtb. Exiting.
```

# 11. 运行 Qemu Xen Dom0 Linux

现在我们已经有了在 Qemu 上运行 Uboot , Xen, Linux Kernel 映像, Root FS, 设备树文件:

```
$ ll
total 1060
drwxrwxr-x  7 lihaiwei lihaiwei    4096 Mar  1 16:43 ./
drwxrwxr-x  8 lihaiwei lihaiwei    4096 Mar  1 14:34 ../
drwxrwxr-x 32 lihaiwei lihaiwei    4096 Feb 25 14:42 busybox_arm64/
lrwxrwxrwx  1 lihaiwei lihaiwei      33 Feb 25 16:30 Image -> linux_arm64/arch/arm64/boot/Image
lrwxrwxrwx  1 lihaiwei lihaiwei      36 Feb 25 16:30 Image.gz -> linux_arm64/arch/arm64/boot/Image.gz
drwxrwxr-x 21 lihaiwei lihaiwei    4096 Mar  1 14:48 linux_arm64/
drwxrwxr-x  2 lihaiwei lihaiwei    4096 Feb 25 18:13 qemu_arm64/
lrwxrwxrwx  1 lihaiwei lihaiwei      33 Feb 26 16:42 qemu-system-aarch64 -> ../qemu/build/qemu-system-aarch64*
lrwxrwxrwx  1 lihaiwei lihaiwei      27 Feb 25 16:32 rootfs.img.gz -> busybox_arm64/rootfs.img.gz
drwxr-xr-x 18 lihaiwei      984    4096 Mar  1 14:56 uboot_arm64/
lrwxrwxrwx  1 lihaiwei lihaiwei      22 Feb 26 21:21 u-boot.bin -> uboot_arm64/u-boot.bin
-rwxrwxr-x  1 lihaiwei lihaiwei     345 Feb 26 21:34 uboot.sh*
-rw-r--r--  1 root     root     1048576 Mar  1 16:43 virt-gicv3.dtb
-rwxrwxr-x  1 lihaiwei lihaiwei     306 Feb 26 21:22 vm.sh*
lrwxrwxrwx  1 lihaiwei      984      13 Mar  1 16:39 xen -> xen_arm64/xen*
drwxr-xr-x  9 lihaiwei      984    4096 Mar  1 16:37 xen_arm64/
```

为了启动 Dom0 上的 Linux Kernel, 我们在 uboot 中通过写入以下 fdt 命令来修改设备树 blob:

* 在 `/chosen/module@0` 中填写我们制作出来的 Image.gz 的大小

* 在 `/chosen/module@1` 中填写我们制作出来的 rootfs.img.gz 的大小

```
fdt addr 0x44000000
fdt resize

fdt set /chosen \#address-cells <1>
fdt set /chosen \#size-cells <1>

fdt mknod /chosen module@0
fdt set /chosen/module@0 compatible "xen,linux-zimage" "xen,multiboot-module"
fdt resize
fdt set /chosen/module@0 compatible "xen,linux-zimage" "xen,multiboot-module"
fdt set /chosen/module@0 reg <0x47000000 0xd67bbf>
fdt set /chosen/module@0 bootargs "rw root=/dev/ram rdinit=/sbin/init earlyprintk=serial,ttyAMA0 console=hvc0 earlycon=xenboot"

fdt mknod /chosen module@1
fdt set /chosen/module@1 compatible "xen,linux-initrd" "xen,multiboot-module"
fdt set /chosen/module@1 reg <0x42000000 0x11d364>

booti 0x49000000 - 0x44000000
```

通过下面的命令, 我们可以计算出 Image.gz 的大小:

```
$ printf "0x%x\n" $(stat -c %s ./linux_arm64/arch/arm64/boot/Image.gz)
0xd67bbf
```

通过下面的命令, 我们可以计算出 rootfs.img.gz 的大小:

```
$ printf "0x%x\n" $(stat -c %s busybox_arm64/rootfs.img.gz)
0x11d364
```

在 Qemu 上运行 Xen, 并由 Xen 启动 Linux Kernel 作为 Dom0 上的 OS, 并指定 rootfs:

```
./qemu-system-aarch64 \
-machine virt,gic_version=3 \
-machine virtualization=true \
-cpu cortex-a57 \
-machine type=virt \
-m 4096 \
-smp 4 \
-bios ./u-boot.bin \
-device loader,file=./xen,force-raw=on,addr=0x49000000 \
-device loader,file=./Image.gz,addr=0x47000000 \
-device loader,file=./virt-gicv3.dtb,addr=0x44000000 \
-device loader,file=./rootfs.img.gz,addr=0x42000000 \
-nographic \
-no-reboot \
-chardev socket,id=qemu-monitor,host=localhost,port=7777,server=on,wait=off,telnet=on \
-mon qemu-monitor,mode=readline
```

并且 uboot 中输入以下 fdt 命令:

```
=> fdt addr 0x44000000
Working FDT set to 44000000
=> fdt resize
=> fdt set /chosen \#address-cells <1>
=> fdt set /chosen \#size-cells <1>
=> fdt mknod /chosen module@0
=> fdt set /chosen/module@0 compatible "xen,linux-zimage" "xen,multiboot-module"
libfdt fdt_setprop(): FDT_ERR_NOSPACE
=> fdt resize
=> fdt set /chosen/module@0 compatible "xen,linux-zimage" "xen,multiboot-module"
=> fdt set /chosen/module@0 reg <0x47000000 0xd67bbf>
=> fdt set /chosen/module@0 bootargs "rw root=/dev/ram rdinit=/sbin/init earlyprintk=serial,ttyAMA0 console=hvc0 earlycon=xenboot"
=> fdt mknod /chosen module@1
=> fdt set /chosen/module@1 compatible "xen,linux-initrd" "xen,multiboot-module"
=> fdt set /chosen/module@1 reg <0x42000000 0x11d364>
=> booti 0x49000000 - 0x44000000
```

在我们输入 Enter 键后, 可进入 Dom0 Linux Kernel 的 console, 示意图如下:

```
[    0.626315] i2c_dev: i2c /dev entries driver
[    0.636005] sdhci: Secure Digital Host Controller Interface driver
[    0.636394] sdhci: Copyright(c) Pierre Ossman
[    0.637591] Synopsys Designware Multimedia Card Interface Driver
[    0.639021] sdhci-pltfm: SDHCI platform and OF driver helper
[    0.643842] ledtrig-cpu: registered to indicate activity on CPUs
[    0.645633] SMCCC: SOC_ID: ARCH_SOC_ID not implemented, skipping ....
[    0.647353] usbcore: registered new interface driver usbhid
[    0.647590] usbhid: USB HID core driver
[    0.659110] NET: Registered PF_PACKET protocol family
[    0.660214] 9pnet: Installing 9P2000 support
[    0.660623] Key type dns_resolver registered
[    0.673382] Timer migration: 1 hierarchy levels; 8 children per group; 1 crossnode level
[    0.676073] registered taskstats version 1
[    0.677085] Loading compiled-in X.509 certificates
[    0.691936] clk: Disabling unused clocks
[    0.692280] PM: genpd: Disabling unused power domains
[    0.692679] ALSA device list:
[    0.692856]   No soundcards found.
[    0.751067] Freeing unused kernel memory: 10048K
[    0.753010] Run /sbin/init as init process
mount: can't read'/etc/fstab': No such file or directory
/etc/init.d/rcS: line 15: can't create /proc/sys/kernel/hotplug: nonexistent directory

Please press Enter to activate this console.
~ #
~ # uname -a
Linux (none) 6.9.0 #1 SMP PREEMPT Tue Feb 25 15:36:27 CST 2025 aarch64 GNU/Linux
~ # ls -l
total 0
drwxrwxr-x    2 1004     1004             0 Feb 25 06:31 bin
drwxrwxr-x    7 1004     1004             0 Mar  1 09:15 dev
drwxrwxr-x    3 1004     1004             0 Feb 25 06:33 etc
lrwxrwxrwx    1 1004     1004            11 Feb 25 06:31 linuxrc -> bin/busybox
drwxr-xr-x    2 0        0                0 Mar  1 09:15 mnt
dr-xr-xr-x  126 0        0                0 Mar  1 09:15 proc
drwx------    2 0        0                0 Feb 25 07:35 root
drwxrwxr-x    2 1004     1004             0 Feb 25 06:31 sbin
dr-xr-xr-x   13 0        0                0 Mar  1 09:15 sys
drwxr-xr-x    2 0        0                0 Mar  1 09:15 tmp
~ #
```

如果遇到因为 amba 设备导致的 kernel 启动失败, log 如下:

```
[    0.177775] audit: type=2000 audit(0.164:1): state=initialized audit_enabled=0 res=1
[    0.187920] thermal_sys: Registered thermal governor 'step_wise'
[    0.188002] thermal_sys: Registered thermal governor 'power_allocator'
[    0.189465] hw-breakpoint: found 6 breakpoint and 4 watchpoint registers.
[    0.192047] ASID allocator initialised with 32768 entries
[    0.196371] Serial: AMBA PL011 UART driver
[    0.215485] Internal error: synchronous external abort: 0000000096000010 [#1] PREEMPT SMP
[    0.216283] Modules linked in:
[    0.216834] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 6.9.0 #1
[    0.217209] Hardware name: linux,dummy-virt (DT)
[    0.217512] pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[    0.217893] pc : amba_read_periphid+0xd8/0x224
[    0.218443] lr : amba_read_periphid+0xc4/0x224
[    0.218668] sp : ffff80008003bc10
[    0.218836] x29: ffff80008003bc10 x28: 0000000000000000 x27: ffffcb889a7b008c
[    0.219274] x26: ffffcb889b50f990 x25: 0000000000000001 x24: ffffcb889a1b3190
[    0.219611] x23: 0000000000000000 x22: ffff0764a38e2400 x21: 0000000000000000
[    0.220144] x20: ffff0764a38e2400 x19: 0000000000001000 x18: 0000000000000020
[    0.220653] x17: 00000000819d8ba4 x16: 0000000088faf828 x15: ffff0764a2c984b8
[    0.221079] x14: ffffffffffffffff x13: 0000000000000000 x12: 0101010101010101
[    0.221412] x11: ffff800080033000 x10: ffffcb889b221000 x9 : ffff0764a2c055b0
[    0.221763] x8 : ffff0764a2ee3640 x7 : ffff8000c0031000 x6 : 0000000000000000
[    0.222100] x5 : 0068000000000f13 x4 : 0000000000000000 x3 : ffff800080031fe0
[    0.222436] x2 : 0000000009030000 x1 : 0000000000000000 x0 : ffff800080031000
[    0.222854] Call trace:
[    0.223056]  amba_read_periphid+0xd8/0x224
[    0.223308]  amba_device_add+0x94/0xb8
[    0.223502]  of_platform_bus_create+0x2c0/0x38c
[    0.223724]  of_platform_populate+0x50/0xfc
[    0.223916]  of_platform_default_populate_init+0xd8/0xf0
[    0.224160]  do_one_initcall+0x70/0x1b8
[    0.224339]  kernel_init_freeable+0x1e0/0x2a8
[    0.224548]  kernel_init+0x20/0x128
[    0.224718]  ret_from_fork+0x10/0x20
[    0.225045] Code: d1008263 52800004 8b030003 52800006 (88dffc62)
[    0.225535] ---[ end trace 0000000000000000 ]---
[    0.226184] Kernel panic - not syncing: Attempted to kill init! exitcode=0x0000000b
[    0.226648] SMP: stopping secondary CPUs
[    0.227237] ---[ end Kernel panic - not syncing: Attempted to kill init! exitcode=0x0000000b ]---
```

需要在生成的设备树中, 禁用 ARM PL061 Advanced Microcontroller Bus Architecture 即可.

```
dtc -I dtb -O dts virt-gicv3.dtb > virt-gicv3.dts
sed 's/compatible ="arm,pl061.*/status = "disabled";/g' virt-gicv3.dts > virt-gicv3-edited.dts
dtc -I dts -O dtb virt-gicv3-edited.dts > virt-gicv3.dtb
```

# 12. 运行 Qemu Xen Dom0 Linux 和 Dom1 Linux

## 12.1. Dom0 和 Dom1 使用同一个 Linux 内核映像

可以直接使用同一个内核映像 Image 作为 Dom0 和 Dom1 的 Linux Kernel 使用, 执行命令:

```
./qemu-system-aarch64 \
-machine virt,gic_version=3 \
-machine virtualization=true \
-cpu cortex-a57 \
-machine type=virt \
-m 8192 \
-smp 4 \
-bios u-boot.bin \
-device loader,file=./xen,force-raw=on,addr=0x4c000000 \
-device loader,file=./Image,addr=0x47000000 \
-device loader,file=./Image,addr=0x53000000 \
-device loader,file=./virt-gicv3.dtb,addr=0x44000000 \
-device loader,file=./rootfs.img.gz,addr=0x42000000 \
-device loader,file=./rootfs.img.gz,addr=0x58000000 \
-nographic \
-no-reboot \
-chardev \
socket,id=qemu-monitor,host=localhost,port=7777,server=on,wait=off,telnet=on \
-mon qemu-monitor,mode=readline
```

注: 在这种场景下, 由于某些限制, 我们这里使用未压缩的 Linux 内核 映像 (因此我们需要测量它们的大小并在 fdt 命令中更改它们, 确保各个映像不会在内存中重叠), 这和上面使用的压缩内核映像 Image.gz 不同:

```
$ printf "0x%x\n" $(stat -c %s linux_arm64/arch/arm64/boot/Image)
0x2a30a00

$ printf "0x%x\n" $(stat -c %s linux_arm64/arch/arm64/boot/Image.gz)
0xd67bbf

$ printf "0x%x\n" $(stat -c %s busybox_arm64/rootfs.img.gz)
0x11d364
```

输入的 fdt 命令:

```
setenv xen_bootargs 'dom0_mem=512M'
fdt addr 0x44000000
fdt resize
fdt set /chosen \#address-cells <1>
fdt set /chosen \#size-cells <1>
fdt set /chosen xen,xen-bootargs \"$xen_bootargs\"

fdt mknod /chosen module@0
fdt set /chosen/module@0 compatible "xen,linux-zimage" "xen,multiboot-module"
fdt set /chosen/module@0 reg <0x47000000 0x2a30a00>
fdt set /chosen/module@0 bootargs "rw root=/dev/ram rdinit=/sbin/init earlyprintk=serial,ttyAMA0 console=hvc0 earlycon=xenboot"

fdt mknod /chosen module@1
fdt set /chosen/module@1 compatible "xen,linux-initrd" "xen,multiboot-module"
fdt set /chosen/module@1 reg <0x42000000 0x11d364>

fdt mknod /chosen domU1
fdt set /chosen/domU1 compatible "xen,domain"
fdt set /chosen/domU1 \#address-cells <1>
fdt set /chosen/domU1 \#size-cells <1>
fdt set /chosen/domU1 \cpus <1>
fdt set /chosen/domU1 \memory <0 548576>
fdt set /chosen/domU1 vpl011
fdt mknod /chosen/domU1 module@0
fdt set /chosen/domU1/module@0 compatible "multiboot,kernel" "multiboot,module"
fdt set /chosen/domU1/module@0 reg <0x53000000 0x2a30a00>
fdt set /chosen/domU1/module@0 bootargs "rw root=/dev/ram rdinit=/sbin/init console=ttyAMA0"
fdt mknod /chosen/domU1 module@1
fdt set /chosen/domU1/module@1 compatible "multiboot,ramdisk" "multiboot,module"
fdt set /chosen/domU1/module@1 reg <0x58000000 0x11d364>
booti 0x4c000000 - 0x44000000
```

fdt 命令执行状态:

```
(0 bootflows, 0 valid)
=> setenv xen_bootargs 'dom0_mem=512M'
=> fdt addr 0x44000000
Working FDT set to 44000000
=> fdt resize
=> fdt set /chosen \#address-cells <1>
=> fdt set /chosen \#size-cells <1>
=> fdt set /chosen xen,xen-bootargs \"$xen_bootargs\"
=> fdt mknod /chosen module@0
libfdt fdt_add_subnode(): FDT_ERR_NOSPACE
=> fdt resize
=> fdt mknod /chosen module@0
=> fdt set /chosen/module@0 compatible "xen,linux-zimage" "xen,multiboot-module"
=> fdt set /chosen/module@0 reg <0x47000000 0x2a30a00>
=> fdt set /chosen/module@0 bootargs "rw root=/dev/ram rdinit=/sbin/init earlyprintk=serial,ttyAMA0 console=hvc0 earlycon=xenboot"
=> fdt mknod /chosen module@1
=>
=> fdt set /chosen/module@1 compatible "xen,linux-initrd" "xen,multiboot-module"
=> fdt set /chosen/module@1 reg <0x42000000 0x11d364>
=>
=> fdt mknod /chosen domU1
=> fdt set /chosen/domU1 compatible "xen,domain"
=> fdt set /chosen/domU1 \#address-cells <1>
=> fdt set /chosen/domU1 \#size-cells <1>
=> fdt set /chosen/domU1 \cpus <1>
=> fdt set /chosen/domU1 \memory <0 548576>
=> fdt set /chosen/domU1 vpl011
=>
=> fdt mknod /chosen/domU1 module@0
=> fdt set /chosen/domU1/module@0 compatible "multiboot,kernel" "multiboot,module"
=> fdt set /chosen/domU1/module@0 reg <0x53000000 0x2a30a00>
=> fdt set /chosen/domU1/module@0 bootargs "rw root=/dev/ram rdinit=/sbin/init console=ttyAMA0"
=>
=> fdt mknod /chosen/domU1 module@1
=> fdt set /chosen/domU1/module@1 compatible "multiboot,ramdisk" "multiboot,module"
=> fdt set /chosen/domU1/module@1 reg <0x58000000 0x11d364>
=> booti 0x4c000000 - 0x44000000
```

执行效果:

```
=> booti 0x4c000000 - 0x44000000
## Flattened Device Tree blob at 44000000
   Booting using the fdt blob at 0x44000000
Working FDT set to 44000000
   Loading Device Tree to 00000000ffff9000, end 00000000ffffefff ... OK
Working FDT set to ffff9000

Starting kernel ...

Xen 4.21-unstable
(XEN) Xen version 4.21-unstable (lihaiwei@) (aarch64-linux-gnu-gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0) debug=y Sat Mar  1 16:37:35 CST 2025
(XEN) Latest ChangeSet: Fri Feb 21 14:41:41 2025 +0000 git:dbe60f244c
(XEN) build-id: a95f2bf0340c48b3f8fdda34b33068c9f54a3729
(XEN) Processor: 00000000411fd070: "ARM Limited", variant: 0x1, part 0xd07,rev 0x0
(XEN) 64-bit Execution:
(XEN)   Processor Features: 0000000001000222 0000000000000000
(XEN)     Exception Levels: EL3:No EL2:64+32 EL1:64+32 EL0:64+32
(XEN)     Extensions: FloatingPoint AdvancedSIMD GICv3-SysReg
(XEN)   Debug Features: 0000000010305106 0000000000000000
(XEN)   Auxiliary Features: 0000000000000000 0000000000000000
(XEN)   Memory Model Features: 0000000000001124 0000000000000000
(XEN)   ISA Features:  0000000000011120 0000000000000000
(XEN) 32-bit Execution:
(XEN)   Processor Features: 0000000000000131:0000000010011001
(XEN)     Instruction Sets: AArch32 A32 Thumb Thumb-2 Jazelle
(XEN)     Extensions: GenericTimer
(XEN)   Debug Features: 0000000003000006
(XEN)   Auxiliary Features: 0000000000000000
(XEN)   Memory Model Features: 0000000010101105 0000000040000000
(XEN)                          0000000001260000 0000000002102211
(XEN)   ISA Features: 0000000002101110 0000000013112111 0000000021232042
(XEN)                 0000000001112131 0000000000011142 0000000000011121
(XEN) Using SMC Calling Convention v1.0
(XEN) Using PSCI v1.1
(XEN) SMP: Allowing 4 CPUs
(XEN) enabled workaround for: ARM erratum 832075
(XEN) enabled workaround for: ARM erratum 834220
(XEN) enabled workaround for: ARM erratum 1319367
(XEN) Generic Timer IRQ: phys=30 hyp=26 virt=27 Freq: 62500 KHz
(XEN) GICv3 initialization:
(XEN)       gic_dist_addr=0x00000008000000
(XEN)       gic_maintenance_irq=25
(XEN)       gic_rdist_stride=0
(XEN)       gic_rdist_regions=1
(XEN)       redistributor regions:
(XEN)         - region 0: 0x000000080a0000 - 0x00000009000000
(XEN) GICv3: 288 lines, (IID 0000043b).
(XEN) GICv3: CPU0: Found redistributor in region 0 @00000a004001c000
(XEN) XSM Framework v1.0.1 initialized
(XEN) Initialising XSM SILO mode
(XEN) Using scheduler: SMP Credit Scheduler rev2 (credit2)
(XEN) Initializing Credit2 scheduler
(XEN)  load_precision_shift: 18
(XEN)  load_window_shift: 30
(XEN)  underload_balance_tolerance: 0
(XEN)  overload_balance_tolerance: -3
(XEN)  runqueues arrangement: socket
(XEN)  cap enforcement granularity: 10ms
(XEN) load tracking window length 1073741824 ns
(XEN) Allocated console ring of 32 KiB.
(XEN) CPU0: Guest atomics will try 1 times before pausing the domain
(XEN) Bringing up CPU1
(XEN) GICv3: CPU1: Found redistributor in region 0 @00000a004003c000
(XEN) CPU1: Guest atomics will try 2 times before pausing the domain
(XEN) CPU 1 booted.
(XEN) Bringing up CPU2
(XEN) GICv3: CPU2: Found redistributor in region 0 @00000a004005c000
(XEN) CPU2: Guest atomics will try 2 times before pausing the domain
(XEN) CPU 2 booted.
(XEN) Bringing up CPU3
(XEN) GICv3: CPU3: Found redistributor in region 0 @00000a004007c000
(XEN) CPU3: Guest atomics will try 2 times before pausing the domain
(XEN) Brought up 4 CPUs
(XEN) CPU 3 booted.
(XEN) I/O virtualisation disabled
(XEN) P2M: 44-bit IPA with 44-bit PA and 8-bit VMID
(XEN) P2M: 4 levels with order-0 root, VTCR 0x0000000080043594
(XEN) Scheduling granularity: cpu, 1 CPU per sched-resource
(XEN) Initializing Credit2 scheduler
(XEN)  load_precision_shift: 18
(XEN)  load_window_shift: 30
(XEN)  underload_balance_tolerance: 0
(XEN)  overload_balance_tolerance: -3
(XEN)  runqueues arrangement: socket
(XEN)  cap enforcement granularity: 10ms
(XEN) load tracking window length 1073741824 ns
(XEN) Adding cpu 0 to runqueue 0
(XEN)  First cpu on runqueue, activating
(XEN) Adding cpu 1 to runqueue 0
(XEN) Adding cpu 2 to runqueue 0
(XEN) Adding cpu 3 to runqueue 0
(XEN) SCMI: No SMCCC 1.1 support, SCMI calls forwarding disabled
(XEN) alternatives: Patching with alt table 00000a00002ee260 -> 00000a00002ef4b4
(XEN) **** No support for ARM_SMCCC_ARCH_WORKAROUND_1. ****
(XEN) **** Please update your firmware.                ****
(XEN) **** No support for ARM_SMCCC_ARCH_WORKAROUND_1. ****
(XEN) **** Please update your firmware.                ****
(XEN) **** Guests without CPU erratum workarounds can deadlock the system! ****
(XEN) **** Only trusted guests should be used.                             ****
(XEN) *** LOADING DOMAIN 0 ***
(XEN) Loading d0 kernel from boot module @ 0000000047000000
(XEN) Loading ramdisk from boot module @ 0000000042000000
(XEN) Grant table range: 0x0000004c000000-0x0000004c040000
(XEN) Allocating 1:1 mappings totalling 512MB for dom0:
(XEN) BANK[0] 0x00000060000000-0x00000080000000 (512MB)
(XEN) Allocating PPI 16 for event channel interrupt
(XEN) d0: extended region 0: 0x40000000->0x4be00000
(XEN) d0: extended region 1: 0x4c200000->0x5fe00000
(XEN) d0: extended region 2: 0x80000000->0x23fe00000
(XEN) Loading zImage from 0000000047000000 to 0000000060000000-0000000062a30a00
(XEN) Loading d0 initrd from 0000000042000000 to 0x0000000068200000-0x000000006831d364
(XEN) Loading d0 DTB to 0x0000000068000000-0x0000000068001e55
(XEN) *** LOADING DOMU cpus=1 memory=0x85ee0KB ***
(XEN) Loading d1 kernel from boot module @ 0000000053000000
(XEN) Loading ramdisk from boot module @ 0000000058000000
(XEN) Allocating mappings totalling 535MB for d1:
(XEN) d1 BANK[0] 0x00000040000000-0x000000617b8000 (535MB)
(XEN) Loading zImage from 0000000053000000 to 0000000040000000-0000000042a30a00
(XEN) Loading d1 initrd from 0000000058000000 to 0x0000000048200000-0x000000004831d364
(XEN) Loading d1 DTB to 0x0000000048000000-0x00000000480004ec
(XEN) Initial low memory virq threshold set at 0x4000 pages.
(XEN) Scrubbing Free RAM in background
(XEN) Std. Loglevel: All
(XEN) Guest Loglevel: All
(XEN) *** Serial input to DOM0 (type 'CTRL-a' three times to switch input)
(XEN) Freed 408kB init memory.
[    0.000000] Booting Linux on physical CPU 0x0000000000 [0x411fd070]
[    0.000000] Linux version 6.9.0 (lihaiwei@D30025378244) (aarch64-linux-gnu-gcc (Ubuntu 9.4.0-1ubuntu1~20.04.2) 9.4.0, GNU ld (GNU Binutils for Ubuntu) 2.34) #1 SMP PREEMPT Tue Feb 25 15:36:27 CST 2025
[    0.000000] KASLR enabled
[    0.000000] random: crng init done
(XEN) d1v0 Unhandled SMC/HVC: 0x84000050
[    0.000000] Machine model: linux,dummy-virt
[    0.000000] earlycon: xenboot0 at I/O port 0x0 (options '')
[    0.000000] printk: legacy bootconsole [xenboot0] enabled
(XEN) d1v0 Unhandled SMC/HVC: 0x8600ff01
[    0.000000] Xen 4.21 support found
[    0.000000] efi: UEFI not found.
[    0.000000] NUMA: No NUMA configuration found
[    0.000000] NUMA: Faking a node at [mem 0x0000000060000000-0x000000007fffffff]
[    0.000000] NUMA: NODE_DATA [mem 0x7fefc9c0-0x7fefefff]
(XEN) d1v0: vGICD: RAZ on reserved register offset 0x00000c
[    0.000000] Zone ranges:
[    0.000000]   DMA      [mem 0x0000000060000000-0x000000007fffffff]
[    0.000000]   DMA32    empty
[    0.000000]   Normal   empty
[    0.000000] Movable zone start for each node
[    0.000000] Early memory node ranges
[    0.000000]   node   0: [mem 0x0000000060000000-0x000000007fffffff]
[    0.000000] Initmem setup node 0 [mem 0x0000000060000000-0x000000007fffffff]
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER4
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER8
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER12
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER16
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER20
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER24
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER28
(XEN) d1v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER32
(XEN) d1v0: vGICR: SGI: unhandled word write 0x000000ffffffff to ICACTIVER0
[    0.000000] cma: Reserved 32 MiB at 0x000000007d400000 on node -1
[    0.000000] psci: probing for conduit method from DT.
[    0.000000] psci: PSCIv1.1 detected in firmware.
[    0.000000] psci: Using standard PSCI v0.2 function IDs
[    0.000000] psci: Trusted OS migration not required
(XEN) d0v0 Unhandled SMC/HVC: 0x84000050
[    0.000000] psci: SMC Calling Convention v1.2
(XEN) d0v0 Unhandled SMC/HVC: 0x8600ff01
[    0.000000] percpu: Embedded 24 pages/cpu s58728 r8192 d31384 u98304
[    0.000000] Detected PIPT I-cache on CPU0
[    0.000000] CPU features: detected: GIC system register CPU interface
[    0.000000] CPU features: detected: Spectre-v2
[    0.000000] CPU features: detected: Spectre-v3a
[    0.000000] CPU features: detected: Spectre-v4
[    0.000000] CPU features: detected: Spectre-BHB
[    0.000000] CPU features: kernel page table isolation forced ON by KASLR
[    0.000000] CPU features: detected: Kernel page table isolation (KPTI)
[    0.000000] CPU features: detected: ARM erratum 1742098
[    0.000000] CPU features: detected: ARM erratum 832075
[    0.000000] CPU features: detected: ARM errata 1165522, 1319367, or 1530923
[    0.000000] alternatives: applying boot alternatives
[    0.000000] Kernel command line: rw root=/dev/ram rdinit=/sbin/init earlyprintk=serial,ttyAMA0 console=hvc0 earlycon=xenboot
[    0.000000] Unknown kernel command line parameters "earlyprintk=serial,ttyAMA0", will be passed to user space.
[    0.000000] Dentry cache hash table entries: 65536 (order: 7, 524288 bytes, linear)
[    0.000000] Inode-cache hash table entries: 32768 (order: 6, 262144 bytes, linear)
[    0.000000] Fallback order for Node 0: 0
[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 129024
[    0.000000] Policy zone: DMA
[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off
[    0.000000] software IO TLB: SWIOTLB bounce buffer size adjusted to 0MB
[    0.000000] software IO TLB: area num 4.
[    0.000000] software IO TLB: SWIOTLB bounce buffer size roundup to 1MB
[    0.000000] software IO TLB: mapped [mem 0x000000007d300000-0x000000007d400000] (1MB)
[    0.000000] Memory: 433940K/524288K available (16768K kernel code, 4802K rwdata, 11436K rodata, 10048K init, 748K bss, 57580K reserved, 32768K cma-reserved)
[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=4, Nodes=1
[    0.000000] rcu: Preemptible hierarchical RCU implementation.
[    0.000000] rcu:     RCU event tracing is enabled.
[    0.000000] rcu:     RCU restricting CPUs from NR_CPUS=512 to nr_cpu_ids=4.
[    0.000000]  Trampoline variant of Tasks RCU enabled.
[    0.000000]  Tracing variant of Tasks RCU enabled.
[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 25 jiffies.
[    0.000000] rcu: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=4
[    0.000000] RCU Tasks: Setting shift to 2 and lim to 1 rcu_task_cb_adjust=1.
[    0.000000] RCU Tasks Trace: Setting shift to 2 and lim to 1 rcu_task_cb_adjust=1.
[    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0
[    0.000000] GICv3: 256 SPIs implemented
[    0.000000] GICv3: 0 Extended SPIs implemented
(XEN) d0v0: vGICD: RAZ on reserved register offset 0x00000c
[    0.000000] Root IRQ handler: gic_handle_irq
[    0.000000] GICv3: GICv3 features: 16 PPIs
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER4
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER8
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER12
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER16
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER20
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER24
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER28
(XEN) d0v0: vGICD: unhandled word write 0x000000ffffffff to ICACTIVER32
[    0.000000] GICv3: CPU0: found redistributor 0 region 0:0x00000000080a0000
(XEN) d0v0: vGICR: SGI: unhandled word write 0x000000ffffffff to ICACTIVER0
[    0.000000] rcu: srcu_init: Setting srcu_struct sizes based on contention.
[    0.000000] arch_timer: cp15 timer(s) running at 62.50MHz (virt).
[    0.000000] clocksource: arch_sys_counter: mask: 0x1ffffffffffffff max_cycles: 0x1cd42e208c, max_idle_ns: 881590405314 ns
[    0.000049] sched_clock: 57 bits at 63MHz, resolution 16ns, wraps every 4398046511096ns
[    0.008171] Console: colour dummy device 80x25
[    0.009529] printk: legacy console [hvc0] enabled
[    0.009529] printk: legacy console [hvc0] enabled
[    0.010381] printk: legacy bootconsole [xenboot0] disabled
[    0.010381] printk: legacy bootconsole [xenboot0] disabled
[    0.012331] Calibrating delay loop (skipped), value calculated using timer frequency.. 125.00 BogoMIPS (lpj=250000)
[    0.012875] pid_max: default: 32768 minimum: 301
[    0.013792] LSM: initializing lsm=capability
[    0.015677] Mount-cache hash table entries: 1024 (order: 1, 8192 bytes, linear)
[    0.016102] Mountpoint-cache hash table entries: 1024 (order: 1, 8192 bytes, linear)
[    0.032885] cacheinfo: Unable to detect cache hierarchy for CPU 0
[    0.041449] xen:grant_table: Grant tables using version 1 layout
[    0.042128] Grant table initialized
[    0.043024] xen:events: Using FIFO-based ABI
[    0.043676] Xen: initializing cpu0
[    0.044941] rcu: Hierarchical SRCU implementation.
[    0.045211] rcu:     Max phase no-delay instances is 1000.
[    0.049253] EFI services will not be available.
[    0.050505] smp: Bringing up secondary CPUs ...
(XEN) d0v1: vGICR: SGI: unhandled word write 0x000000ffffffff to ICACTIVER0
(XEN) d0v2: vGICR: SGI: unhandled word write 0x000000ffffffff to ICACTIVER0
(XEN) d0v3: vGICR: SGI: unhandled word write 0x000000ffffffff to ICACTIVER0
[    0.056396] Detected PIPT I-cache on CPU1
[    0.057075] GICv3: CPU1: found redistributor 1 region 0:0x00000000080c0000
[    0.057729] Xen: initializing cpu1
[    0.057979] CPU1: Booted secondary processor 0x0000000001 [0x411fd070]
[    0.062845] Detected PIPT I-cache on CPU2
[    0.062980] GICv3: CPU2: found redistributor 2 region 0:0x00000000080e0000
[    0.063487] Xen: initializing cpu2
[    0.063599] CPU2: Booted secondary processor 0x0000000002 [0x411fd070]
[    0.071393] Detected PIPT I-cache on CPU3
[    0.072202] GICv3: CPU3: found redistributor 3 region 0:0x0000000008100000
[    0.075355] Xen: initializing cpu3
[    0.077981] CPU3: Booted secondary processor 0x0000000003 [0x411fd070]
[    0.078782] smp: Brought up 1 node, 4 CPUs
[    0.082067] SMP: Total of 4 processors activated.
[    0.082490] CPU: All CPU(s) started at EL1
[    0.082935] CPU features: detected: 32-bit EL0 Support
[    0.083180] CPU features: detected: 32-bit EL1 Support
[    0.083465] CPU features: detected: CRC32 instructions
[    0.091389] alternatives: applying system-wide alternatives
(XEN) DOM1: [    0.000000] Booting Linux on physical CPU 0x0000000000 [0x411fd070]
(XEN) DOM1: [    0.000000] Linux version 6.9.0 (lihaiwei@D30025378244) (aarch64-linux-gnu-gcc (Ubuntu 9.4.0-1ubuntu1~20.04.2) 9.4.0, GNU l
(XEN) DOM1: d (GNU Binutils for Ubuntu) 2.34) #1 SMP PREEMPT Tue Feb 25 15:36:27 CST 2025
(XEN) DOM1: [    0.000000] KASLR disabled due to lack of seed
(XEN) DOM1: [    0.000000] efi: UEFI not found.
(XEN) DOM1: [    0.000000] NUMA: No NUMA configuration found
(XEN) DOM1: [    0.000000] NUMA: Faking a node at [mem 0x0000000040000000-0x00000000617b7fff]
(XEN) DOM1: [    0.000000] NUMA: NODE_DATA [mem 0x616b19c0-0x616b3fff]
(XEN) DOM1: [    0.000000] Zone ranges:
(XEN) DOM1: [    0.000000]   DMA      [mem 0x0000000040000000-0x00000000617b7fff]
[    0.140712] devtmpfs: initialized
(XEN) DOM1: [    0.000000]   DMA32    empty
(XEN) DOM1: [    0.000000]   Normal   empty
(XEN) DOM1: [    0.000000] Movable zone start for each node
(XEN) DOM1: [    0.000000] Early memory node ranges
(XEN) DOM1: [    0.000000]   node   0: [mem 0x0000000040000000-0x00000000617b7fff]
(XEN) DOM1: [    0.000000] Initmem setup node 0 [mem 0x0000000040000000-0x00000000617b7fff]
(XEN) DOM1: [    0.000000] On node 0, zone DMA: 26696 pages in unavailable ranges
(XEN) DOM1: [    0.000000] cma: Reserved 32 MiB at 0x000000005ea00000 on node -1
(XEN) DOM1: [    0.000000] psci: probing for conduit method from DT.
(XEN) DOM1: [    0.000000] psci: PSCIv1.1 detected in firmware.
(XEN) DOM1: [    0.000000] psci: Using standard PSCI v0.2 function IDs
(XEN) DOM1: [    0.000000] psci: Trusted OS migration not required
(XEN) DOM1: [    0.000000] psci: SMC Calling Convention v1.2
(XEN) DOM1: [    0.000000] percpu: Embedded 24 pages/cpu s58728 r8192 d31384 u98304
(XEN) DOM1: [    0.000000] Detected PIPT I-cache on CPU0
(XEN) DOM1: [    0.000000] CPU features: detected: GIC system register CPU interface
(XEN) DOM1: [    0.000000] CPU features: detected: Spectre-v2
[    0.157932] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns
(XEN) DOM1: [    0.000000] CPU features: detected: Spectre-v3a
[    0.159373] futex hash table entries: 1024 (order: 4, 65536 bytes, linear)
(XEN) DOM1: [    0.000000] CPU features: detected: Spectre-v4
(XEN) DOM1: [    0.000000] CPU features: detected: Spectre-BHB
(XEN) DOM1: [    0.000000] CPU features: detected: ARM erratum 1742098
(XEN) DOM1: [    0.000000] CPU features: detected: ARM erratum 832075
[    0.163373] pinctrl core: initialized pinctrl subsystem
(XEN) DOM1: [    0.000000] CPU features: detected: ARM errata 1165522, 1319367, or 1530923
(XEN) DOM1: [    0.000000] alternatives: applying boot alternatives
(XEN) DOM1: [    0.000000] Kernel command line: rw root=/dev/ram rdinit=/sbin/init console=ttyAMA0
(XEN) DOM1: [    0.000000] Dentry cache hash table entries: 131072 (order: 8, 1048576 bytes, linear)
[    0.168914] DMI not present or invalid.
(XEN) DOM1: [    0.000000] Inode-cache hash table entries: 65536 (order: 7, 524288 bytes, linear)
(XEN) DOM1: [    0.000000] Fallback order for Node 0: 0
(XEN) DOM1: [    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 135001
(XEN) DOM1: [    0.000000] Policy zone: DMA
(XEN) DOM1: [    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off
(XEN) DOM1: [    0.000000] software IO TLB: SWIOTLB bounce buffer size adjusted to 0MB
(XEN) DOM1: [    0.000000] software IO TLB: area num 1.
(XEN) DOM1: [    0.000000] software IO TLB: SWIOTLB bounce buffer size roundup to 1MB
(XEN) DOM1: [    0.000000] software IO TLB: mapped [mem 0x000000005e900000-0x000000005ea00000] (1MB)
(XEN) DOM1: [    0.000000] Memory: 455692K/548576K available (16768K kernel code, 4802K rwdata, 11436K rodata, 10048K init, 748K bss, 6011
(XEN) DOM1: 6K reserved, 32768K cma-reserved)
(XEN) DOM1: [    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1
(XEN) DOM1: [    0.000000] rcu: Preemptible hierarchical RCU implementation.
(XEN) DOM1: [    0.000000] rcu:         RCU event tracing is enabled.
[    0.199087] NET: Registered PF_NETLINK/PF_ROUTE protocol family
(XEN) DOM1: [    0.000000] rcu:         RCU restricting CPUs from NR_CPUS=512 to nr_cpu_ids=1.
(XEN) DOM1: [    0.000000]      Trampoline variant of Tasks RCU enabled.
(XEN) DOM1: [    0.000000]      Tracing variant of Tasks RCU enabled.
(XEN) DOM1: [    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 25 jiffies.
(XEN) DOM1: [    0.000000] rcu: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
(XEN) DOM1: [    0.000000] RCU Tasks: Setting shift to 0 and lim to 1 rcu_task_cb_adjust=1.
(XEN) DOM1: [    0.000000] RCU Tasks Trace: Setting shift to 0 and lim to 1 rcu_task_cb_adjust=1.
(XEN) DOM1: [    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0
(XEN) DOM1: [    0.000000] GICv3: 256 SPIs implemented
(XEN) DOM1: [    0.000000] GICv3: 0 Extended SPIs implemented
[    0.210939] DMA: preallocated 128 KiB GFP_KERNEL pool for atomic allocations
(XEN) DOM1: [    0.000000] Root IRQ handler: gic_handle_irq
(XEN) DOM1: [    0.000000] GICv3: GICv3 features: 16 PPIs
[    0.212623] DMA: preallocated 128 KiB GFP_KERNEL|GFP_DMA pool for atomic allocations
(XEN) DOM1: [    0.000000] GICv3: CPU0: found redistributor 0 region 0:0x0000000003020000
[    0.214904] DMA: preallocated 128 KiB GFP_KERNEL|GFP_DMA32 pool for atomic allocations
[    0.215656] audit: initializing netlink subsys (disabled)
(XEN) DOM1: [    0.000000] rcu: srcu_init: Setting srcu_struct sizes based on contention.
(XEN) DOM1: [    0.000000] arch_timer: cp15 timer(s) running at 62.50MHz (virt).
[    0.219034] audit: type=2000 audit(0.196:1): state=initialized audit_enabled=0 res=1
(XEN) DOM1: [    0.000000] clocksource: arch_sys_counter: mask: 0x1ffffffffffffff max_cycles: 0x1cd42e208c, max_idle_ns: 881590405314 ns
(XEN) DOM1: [    0.000049] sched_clock: 57 bits at 63MHz, resolution 16ns, wraps every 4398046511096ns
(XEN) DOM1: [    0.006661] Console: colour dummy device 80x25
(XEN) DOM1: [    0.008348] Calibrating delay loop (skipped), value calculated using timer frequency.. 125.00 BogoMIPS (lpj=250000)
(XEN) DOM1: [    0.008855] pid_max: default: 32768 minimum: 301
(XEN) DOM1: [    0.010313] LSM: initializing lsm=capability
(XEN) DOM1: [    0.012297] Mount-cache hash table entries: 2048 (order: 2, 16384 bytes, linear)
[    0.228001] thermal_sys: Registered thermal governor 'step_wise'
(XEN) DOM1: [    0.012330] Mountpoint-cache hash table entries: 2048 (order: 2, 16384 bytes, linear)
(XEN) DOM1: [    0.038330] rcu: Hierarchical SRCU implementation.
[    0.228090] thermal_sys: Registered thermal governor 'power_allocator'
[    0.229845] hw-breakpoint: found 6 breakpoint and 4 watchpoint registers.
(XEN) DOM1: [    0.038362] rcu:         Max phase no-delay instances is 1000.
(XEN) DOM1: [    0.044058] EFI services will not be available.
[    0.233529] ASID allocator initialised with 32768 entries
(XEN) DOM1: [    0.044441] smp: Bringing up secondary CPUs ...
(XEN) DOM1: [    0.044921] smp: Brought up 1 node, 1 CPU
(XEN) DOM1: [    0.044947] SMP: Total of 1 processors activated.
(XEN) DOM1: [    0.044967] CPU: All CPU(s) started at EL1
(XEN) DOM1: [    0.045385] CPU features: detected: 32-bit EL0 Support
(XEN) DOM1: [    0.045395] CPU features: detected: 32-bit EL1 Support
(XEN) DOM1: [    0.045756] CPU features: detected: CRC32 instructions
[    0.240213] Serial: AMBA PL011 UART driver
(XEN) DOM1: [    0.052000] alternatives: applying system-wide alternatives
(XEN) DOM1: [    0.086696] devtmpfs: initialized
(XEN) DOM1: [    0.099204] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns
(XEN) DOM1: [    0.099774] futex hash table entries: 256 (order: 2, 16384 bytes, linear)
(XEN) DOM1: [    0.103098] pinctrl core: initialized pinctrl subsystem
(XEN) DOM1: [    0.107489] DMI not present or invalid.
(XEN) DOM1: [    0.136900] NET: Registered PF_NETLINK/PF_ROUTE protocol family
(XEN) DOM1: [    0.149701] DMA: preallocated 128 KiB GFP_KERNEL pool for atomic allocations
(XEN) DOM1: [    0.151265] DMA: preallocated 128 KiB GFP_KERNEL|GFP_DMA pool for atomic allocations
(XEN) DOM1: [    0.151568] DMA: preallocated 128 KiB GFP_KERNEL|GFP_DMA32 pool for atomic allocations
(XEN) DOM1: [    0.151751] audit: initializing netlink subsys (disabled)
(XEN) DOM1: [    0.153794] audit: type=2000 audit(0.132:1): state=initialized audit_enabled=0 res=1
(XEN) DOM1: [    0.160866] thermal_sys: Registered thermal governor 'step_wise'
(XEN) DOM1: [    0.160920] thermal_sys: Registered thermal governor 'power_allocator'
(XEN) DOM1: [    0.161289] cpuidle: using governor menu
(XEN) DOM1: [    0.162201] hw-breakpoint: found 6 breakpoint and 4 watchpoint registers.
(XEN) DOM1: [    0.164412] ASID allocator initialised with 65536 entries
(XEN) DOM1: [    0.170344] Serial: AMBA PL011 UART driver
(XEN) DOM1: [    0.183257] 22000000.sbsa-uart: ttyAMA0 at MMIO 0x22000000 (irq = 12, base_baud = 0) is a SBSA
(XEN) DOM1: [    0.183965] printk: legacy console [ttyAMA0] enabled
[    0.268371] Modules: 2G module region forced by RANDOMIZE_MODULE_REGION_FULL
[    0.268882] Modules: 0 pages in range for non-PLT usage
(XEN) DOM1: [    0.325368] Modules: 21760 pages in range for non-PLT usage
(XEN) DOM1: [    0.325405] Modules: 513280 pages in range for PLT usage
[    0.268942] Modules: 513280 pages in range for PLT usage
[    0.277931] HugeTLB: registered 1.00 GiB page size, pre-allocated 0 pages
[    0.279310] HugeTLB: 0 KiB vmemmap can be freed for a 1.00 GiB page
[    0.279742] HugeTLB: registered 32.0 MiB page size, pre-allocated 0 pages
[    0.280331] HugeTLB: 0 KiB vmemmap can be freed for a 32.0 MiB page
[    0.280778] HugeTLB: registered 2.00 MiB page size, pre-allocated 0 pages
[    0.281237] HugeTLB: 0 KiB vmemmap can be freed for a 2.00 MiB page
[    0.281663] HugeTLB: registered 64.0 KiB page size, pre-allocated 0 pages
[    0.282110] HugeTLB: 0 KiB vmemmap can be freed for a 64.0 KiB page
(XEN) DOM1: [    0.333667] HugeTLB: registered 1.00 GiB page size, pre-allocated 0 pages
(XEN) DOM1: [    0.340307] HugeTLB: 0 KiB vmemmap can be freed for a 1.00 GiB page
(XEN) DOM1: [    0.341557] HugeTLB: registered 32.0 MiB page size, pre-allocated 0 pages
[    0.286447] Demotion targets for Node 0: null
(XEN) DOM1: [    0.342816] HugeTLB: 0 KiB vmemmap can be freed for a 32.0 MiB page
(XEN) DOM1: [    0.344432] HugeTLB: registered 2.00 MiB page size, pre-allocated 0 pages
(XEN) DOM1: [    0.345681] HugeTLB: 0 KiB vmemmap can be freed for a 2.00 MiB page
(XEN) DOM1: [    0.346919] HugeTLB: registered 64.0 KiB page size, pre-allocated 0 pages
(XEN) DOM1: [    0.348289] HugeTLB: 0 KiB vmemmap can be freed for a 64.0 KiB page
[    0.295788] ACPI: Interpreter disabled.
(XEN) DOM1: [    0.353103] Demotion targets for Node 0: null
[    0.300624] xen:balloon: Initialising balloon driver
(XEN) DOM1: [    0.358800] ACPI: Interpreter disabled.
[    0.305252] iommu: Default domain type: Translated
[    0.305607] iommu: DMA domain TLB invalidation policy: strict mode
(XEN) DOM1: [    0.362755] iommu: Default domain type: Translated
(XEN) DOM1: [    0.363805] iommu: DMA domain TLB invalidation policy: strict mode
[    0.308736] SCSI subsystem initialized
(XEN) DOM1: [    0.366137] SCSI subsystem initialized
[    0.312641] usbcore: registered new interface driver usbfs
[    0.313475] usbcore: registered new interface driver hub
(XEN) DOM1: [    0.369319] usbcore: registered new interface driver usbfs
[    0.314103] usbcore: registered new device driver usb
(XEN) DOM1: [    0.371094] usbcore: registered new interface driver hub
[    0.316218] pps_core: LinuxPPS API ver. 1 registered
[    0.316631] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti <giometti@linux.it>
[    0.317296] PTP clock support registered
(XEN) DOM1: [    0.372562] usbcore: registered new device driver usb
[    0.318269] EDAC MC: Ver: 3.0.0
(XEN) DOM1: [    0.375580] pps_core: LinuxPPS API ver. 1 registered
(XEN) DOM1: [    0.376683] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti <giometti@linux.it>
[    0.322083] scmi_core: SCMI protocol bus registered
(XEN) DOM1: [    0.378369] PTP clock support registered
(XEN) DOM1: [    0.380003] EDAC MC: Ver: 3.0.0
[    0.326172] FPGA manager framework
[    0.326907] Advanced Linux Sound Architecture Driver Initialized.
(XEN) DOM1: [    0.382821] scmi_core: SCMI protocol bus registered
(XEN) DOM1: [    0.387509] FPGA manager framework
(XEN) DOM1: [    0.388792] Advanced Linux Sound Architecture Driver Initialized.
[    0.339842] vgaarb: loaded
[    0.343432] clocksource: Switched to clocksource arch_sys_counter
(XEN) DOM1: [    0.400828] vgaarb: loaded
[    0.344893] VFS: Disk quotas dquot_6.6.0
[    0.345395] VFS: Dquot-cache hash table entries: 512 (order 0, 4096 bytes)
[    0.346811] pnp: PnP ACPI: disabled
(XEN) DOM1: [    0.405343] clocksource: Switched to clocksource arch_sys_counter
(XEN) DOM1: [    0.408976] VFS: Disk quotas dquot_6.6.0
(XEN) DOM1: [    0.410610] VFS: Dquot-cache hash table entries: 512 (order 0, 4096 bytes)
(XEN) DOM1: [    0.412974] pnp: PnP ACPI: disabled
(XEN) DOM1: [    0.429269] NET: Registered PF_INET protocol family
(XEN) DOM1: [    0.431569] IP idents hash table entries: 16384 (order: 5, 131072 bytes, linear)
(XEN) DOM1: [    0.436965] tcp_listen_portaddr_hash hash table entries: 512 (order: 1, 8192 bytes, linear)
(XEN) DOM1: [    0.439223] Table-perturb hash table entries: 65536 (order: 6, 262144 bytes, linear)
(XEN) DOM1: [    0.440815] TCP established hash table entries: 8192 (order: 4, 65536 bytes, linear)
(XEN) DOM1: [    0.442941] TCP bind hash table entries: 8192 (order: 6, 262144 bytes, linear)
(XEN) DOM1: [    0.444493] TCP: Hash tables configured (established 8192 bind 8192)
(XEN) DOM1: [    0.447151] UDP hash table entries: 512 (order: 2, 16384 bytes, linear)
(XEN) DOM1: [    0.448946] UDP-Lite hash table entries: 512 (order: 2, 16384 bytes, linear)
(XEN) DOM1: [    0.451761] NET: Registered PF_UNIX/PF_LOCAL protocol family
(XEN) DOM1: [    0.455563] RPC: Registered named UNIX socket transport module.
(XEN) DOM1: [    0.456818] RPC: Registered udp transport module.
(XEN) DOM1: [    0.457991] RPC: Registered tcp transport module.
(XEN) DOM1: [    0.458962] RPC: Registered tcp-with-tls transport module.
(XEN) DOM1: [    0.460062] RPC: Registered tcp NFSv4.1 backchannel transport module.
(XEN) DOM1: [    0.461458] PCI: CLS 0 bytes, default 64
[    0.409290] NET: Registered PF_INET protocol family
(XEN) DOM1: [    0.465736] Unpacking initramfs...
[    0.410876] IP idents hash table entries: 8192 (order: 4, 65536 bytes, linear)
(XEN) DOM1: [    0.469671] kvm [1]: HYP mode not available
[    0.416038] tcp_listen_portaddr_hash hash table entries: 256 (order: 0, 4096 bytes, linear)
[    0.416617] Table-perturb hash table entries: 65536 (order: 6, 262144 bytes, linear)
[    0.417093] TCP established hash table entries: 4096 (order: 3, 32768 bytes, linear)
[    0.417679] TCP bind hash table entries: 4096 (order: 5, 131072 bytes, linear)
[    0.418220] TCP: Hash tables configured (established 4096 bind 4096)
[    0.419673] UDP hash table entries: 256 (order: 1, 8192 bytes, linear)
[    0.420270] UDP-Lite hash table entries: 256 (order: 1, 8192 bytes, linear)
[    0.421578] NET: Registered P(XEN) DOM1: [    0.477397] Initialise system trusted keyrings
F_UNIX/PF_LOCAL protocol family
(XEN) DOM1: [    0.479904] workingset: timestamp_bits=42 max_order=17 bucket_order=0
[    0.426703] RPC: Registered named UNIX socket transport module.
[    0.427286] RPC: Registered udp transport module.
[    0.427606] RPC: Registered tcp transport module.
[    0.427921] RPC: Registered tcp-with-tls transport module.
[    0.428248] RPC: Registered tcp NFSv4.1 backchannel transport module.
[    0.428684] PCI: CLS 0 bytes, default 64
(XEN) DOM1: [    0.486832] squashfs: version 4.0 (2009/01/31) Phillip Lougher
[    0.432607] Unpacking initramfs...
[    0.438014] kvm [1]: HYP mode not available
(XEN) DOM1: [    0.493927] NFS: Registering the id_resolver key type
(XEN) DOM1: [    0.495470] Key type id_resolver registered
(XEN) DOM1: [    0.496406] Key type id_legacy registered
[    0.442322] Initialise system trusted keyrings
[    0.445919] workingset: timestamp_bits=42 max_order=17 bucket_order=0
(XEN) DOM1: [    0.501731] nfs4filelayout_init: NFSv4 File Layout Driver Registering...
[    0.448463] squashfs: version 4.0 (2009/01/31) Phillip Lougher
(XEN) DOM1: [    0.503483] nfs4flexfilelayout_init: NFSv4 Flexfile Layout Driver Registering...
[    0.451758] NFS: Registering the id_resolver key type
[    0.452465] Key type id_resolver registered
[    0.452763] Key type id_legacy registered
[    0.453280] nfs4filelayout_init: NFSv4 File Layout Driver Registering...
[    0.453718] nfs4flexfilelayout_init: NFSv4 Flexfile Layout Driver Registering...
[    0.455276] 9p: Installing v9fs 9p2000 file system support
(XEN) DOM1: [    0.513286] 9p: Installing v9fs 9p2000 file system support
[    0.484872] Freeing initrd memory: 1140K
[    0.485425] Key type asymmetric registered
[    0.485949] Asymmetric key parser 'x509' registered
[    0.486590] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 245)
[    0.487282] io scheduler mq-deadline registered
[    0.487537] io scheduler kyber registered
[    0.488022] io scheduler bfq registered
[    0.508121] pci-host-generic 4010000000.pcie: host bridge /pcie@10000000 ranges:
[    0.509244] pci-host-generic 4010000000.pcie:       IO 0x003eff0000..0x003effffff -> 0x0000000000
...
(XEN) DOM1: [    0.895126] Freeing unused kernel memory: 10048K
[    0.841526] VFIO - User Level meta-driver version: 0.3
(XEN) DOM1: [    0.898522] Run /sbin/init as init process
[    0.847890] usbcore: registered new interface driver usb-storage
[    0.856240] rtc-pl031 9010000.pl031: registered as rtc0
[    0.857302] rtc-pl031 9010000.pl031: setting system clock to 2025-03-01T09:59:12 UTC (1740823152)
[    0.859678] i2c_dev: i2c /dev entries driver
[    0.869531] sdhci: Secure Digital Host Controller Interface driver
[    0.869986] sdhci: Copyright(c) Pierre Ossman
[    0.871246] Synopsys Designware Multimedia Card Interface Driver
[    0.872942] sdhci-pltfm: SDHCI platform and OF driver helper
[    0.878851] ledtrig-cpu: registered to indicate activity on CPUs
[    0.881007] SMCCC: SOC_ID: ARCH_SOC_ID not implemented, skipping ....
[    0.883222] usbcore: registered new interface driver usbhid
[    0.883559] usbhid: USB HID core driver
[    0.898419] NET: Registered PF_PACKET protocol family
[    0.900142] 9pnet: Installing 9P2000 support
[    0.900650] Key type dns_resolver registered
[    0.916548] Timer migration: 1 hierarchy levels; 8 children per group; 1 crossnode level
[    0.919099] registered taskstats version 1
[    0.921237] Loading compiled-in X.509 certificates
(XEN) DOM1: mount: can't read'/etc/fstab': No such file or directory
[    0.942377] clk: Disabling unused clocks
[    0.943289] PM: genpd: Disabling unused power domains
[    0.944127] ALSA device list:
[    0.944440]   No soundcards found.
(XEN) DOM1: /etc/init.d/rcS: line 15: can't create /proc/sys/kernel/hotplug: nonexistent directory
[    1.036711] Freeing unused kernel memory: 10048K
[    1.038794] Run /sbin/init as init process
(XEN) DOM1:
mount: can't read'/etc/fstab': No such file or directory
/etc/init.d/rcS: line 15: can't create /proc/sys/kernel/hotplug: nonexistent directory

Please press Enter to activate this console.
~ # [   11.006235] platform gpio-keys: deferred probe pending: gpio-keys: failed to get gpio

~ # uname -a
Linux (none) 6.9.0 #1 SMP PREEMPT Tue Feb 25 15:36:27 CST 2025 aarch64 GNU/Linux
~ #
~ #
```

## 12.2. Dom0 和 Dom1 使用不同的 Linux 内核映像

```
cd $WORK_DIR
mkdir linux-for-domU
cp -r linux linux-for-domU/
cd linux-for-domU/
make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
```

在生成的. config 中把 "CONFIG_XEN_DOM0=y" 注释掉, 保留 "CONFIG_XEN=y"

编译内核, 并将编译后的内核镜像拷贝到指定目录:

```
make -j4 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
cp ./arch/arm64/boot/Image $BUILD_DIR/busybox_arm64/ImageU
```

运行命令:

```
./qemu-system-aarch64 \
-machine virt,gic_version=3 \
-machine virtualization=true \
-cpu cortex-a57 \
-machine type=virt \
-m 8192 \
-smp 4 \
-bios u-boot.bin \
-device loader,file=xen,force-raw=on,addr=0x4c000000 \
-device loader,file=Image,addr=0x47000000 \
-device loader,file=ImageU,addr=0x53000000 \
-device loader,file=virt-gicv3.dtb,addr=0x44000000 \
-device loader,file=rootfs.img.gz,addr=0x42000000 \
-device loader,file=rootfs.img.gz,addr=0x58000000 \
-nographic \
-no-reboot \
-chardev socket,id=qemu-monitor,host=localhost,port=7777,server,nowait,telnet \
-mon qemu-monitor,mode=readline
```

