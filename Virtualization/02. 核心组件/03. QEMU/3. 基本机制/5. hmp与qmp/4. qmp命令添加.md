
这里以一个例子介绍如何添加qmp命令. 添加一个qmp命令包括如下4个步骤.

1)定义符合QAPI方式的qmp命令及其参数和返回值的类型.

2)完成新增qmp的功能函数, 既可以将这个函数放在相关功能的模块, 也可以放在qmp.c文件中.

3)此时完成了一个qmp命令的编写, 可以通过2.5.2节的方式调用该qmp功能.

4)编写相应的hmp命令. 这不是一个必需的步骤, 只有在该命令对human有意义的时候才需要编写. hmp功能函数直接调用对应的qmp函数.

比如要添加一个"qmp-test"的qmp命令, 执行该命令的时候会设置一个全局变量. 第一步在qapi-schema.json文件的最后一行添加如下内容.

```json

```

接着, 在qmp.c文件的最后实现"qmp-test"命令的处理函数.

```cpp

```

这个时候可以使用如下的json命令向qmp发起功能请求.

```json

```

将这个命令作为hmp也比较合适, 这里也可以添加一个hmp命令, 在hmp-commands.hx的中间添加下面的内容.

```

```

在hmp.c的文件最后添加实现hmp命令功能的函数.

```cpp

```

需要在hmp.h中声明一下该函数

```cpp

```

重新编译QEMU之后, 就能够使用"qmp-test 80"向QEMU发送hmp命令了.