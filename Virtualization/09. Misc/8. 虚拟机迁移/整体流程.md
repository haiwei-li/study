虚拟机的热迁移主要有下面几步:

* 在目标宿主机上准备虚拟机运行环境, 如挂载共享存储, 创建虚拟网络等;
* 从源宿主机建立到目标宿主机的连接, 用于传输虚拟机的状态, 比如内存;
* 源端需要捕捉内存的更改并记录在内存传输过程中有哪些页面被改动, 这些脏页需要在下一轮迭代中继续传输;
* 传输全量内存;
* 本轮内存传输完毕后, 如果剩下的脏页数量能在设定的停机时间内传输完毕, 那么将虚拟机停机, 否则继续传输脏内存, 直到脏内存的量收敛到可以在预定时间内传输完成为止;
* 传输余下的脏内存, 以及停机时 CPU 寄存器和各个子系统的状态;
* 此时源端和目标端的虚拟机状态完全一致, 在目标端让虚拟机恢复运行, 迁移完毕.
如上所述, 源端需要去捕获内存的更改, 在当前的环境下是采用写保护和脏页位图的方法, 即先把内存全部变为只读, 在虚拟机写内存时就会产生异常被 KVM 内核模块捕获并且记录到脏页位图, 该脏页位图最后被复制到 QEMU, 据此 QEMU 能知道哪些内存被更改.

对于脏页内存的捕获, 我们主要通过两大方式提升热迁移效率: 1)采用快速写保护算法, 该算法是无锁的并且算法复杂度为 O(1), 这就意味着它的性能与虚拟机的内存大小和工作负载无关. 2)采用 KVM 内核模块和 QEMU 共享脏页位图的方法, 实现零拷贝以及减少用户态和内核态的上下文切换.

另外在迁移脏块的时候, 针对子机内部 IO 性能下降的问题, 优化热迁移块大小, 避免传输无用数据, 提升热迁移成功率. 当然, 腾讯云还有很多其他提升热迁移性能和稳定性的优化方法, 在此就不一一列举了.


https://mp.weixin.qq.com/s/p8FPRBne5GfyJfvGHFvbVg

https://mp.weixin.qq.com/s/S-Lk-oVPvgASafCZnb5KMg

https://mp.weixin.qq.com/s/_g4awGK7hnW9FgeOJFtuAQ