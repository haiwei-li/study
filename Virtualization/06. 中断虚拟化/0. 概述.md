
在本章中, 我们首先概述了对于**单核虚拟机**和**多核虚拟机**, KVM 在 VMX 扩展下是如何虚拟中断的, 以及针对软件虚拟中断的缺陷, Intel 是如何从硬件层面支持中断虚拟化的. 我们还探讨了 KVM 如何利用硬件虚拟化的特性提高虚拟中断的性能.

然后, 我们从单核系统开始, 结合 PIC(8259A) 的硬件原理, 详细探讨了 KVM 是如何虚拟 8259A 的, 以及虚拟 8259A 是如何利用 VMX 扩展, 向 Guest 注入中断的. 随后, 我们阐述了支持多核系统的 APIC 的虚拟化, 我们讨论了外设如何发送中断给 Guest, 以及 Guest 内多核之间如何发送核间中断 (IPI). 我们还探讨了绕开 I/O APIC, 从设备直接向 LAPIC 发送基于消息的 MSI(X) 机制的虚拟化.

最后, 我们讨论了 Intel 为了提高中断虚拟化的性能, 在硬件层面增加的特性, 包括 **virtual-APIC page**, **虚拟中断逻辑**以及 **posted-interrupt processing**.

中断芯片可以在用户空间中模拟, 也可以在内核空间模拟, 但是因为中断芯片需要密集地与 Guest 以及内核中的 KVM 模块交互, 显然在内核空间模拟更合理, 所以 KVM 在内核中实现中断芯片的模拟.
